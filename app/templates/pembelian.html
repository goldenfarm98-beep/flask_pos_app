{% extends "base.html" %}

{% block title %}Pembelian{% endblock %}

{% block content %}
{% set supplier_count = supplier_payload|length %}
{% set product_count = product_payload|length %}

<div class="d-flex align-items-center justify-content-between flex-wrap mb-3">
    <div class="mb-2">
        <h1 class="h4 font-weight-bold mb-1">Pembelian & Restock</h1>
        <p class="text-muted mb-0">Supplier: {{ supplier_count }} • Produk: {{ product_count }}. Tambah faktur baru di bawah.</p>
    </div>
    <div class="btn-group">
        <a href="#purchase-form" class="btn btn-sm btn-primary"><i class="fas fa-file-invoice mr-1"></i>Faktur Baru</a>
        <a href="{{ url_for('main.supplier') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-truck mr-1"></i>Supplier</a>
        <a href="{{ url_for('main.produk') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-box-open mr-1"></i>Produk</a>
    </div>
</div>

{% if purchase_stat_cards %}
<div class="row stat-grid mb-4">
    {% for card in purchase_stat_cards %}
        <div class="col-sm-6 col-xl-3 mb-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="stat-icon {{ card.accent }}">
                            <i class="fas {{ card.icon }}"></i>
                        </span>
                    <span class="badge badge-pill badge-soft-primary text-uppercase font-weight-semibold px-3">{{ card.label }}</span>
                </div>
                    <div class="stat-value mb-1">
                        {% if card.type == 'currency' %}
                            {{ ('Rp {:,.0f}'.format(card.value)).replace(',', '.') }}
                        {% else %}
                            {{ '{:,}'.format(card.value).replace(',', '.') }}
                        {% endif %}
                    </div>
                    <p class="small text-muted mb-0">{{ card.description }}</p>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="row align-items-start" id="purchase-form">
    <div class="col-lg-8">
        <form id="pembelianForm" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="card shadow-sm mb-4 data-panel">
                <div class="card-header bg-white border-0">
                    <h2 class="h5 font-weight-bold mb-0">Data Pembelian</h2>
                </div>
                <div class="card-body data-grid">
                    <div class="form-group">
                        <label for="tanggal_faktur" class="font-weight-semibold">Tanggal faktur</label>
                        <input type="date" class="form-control form-control-lg" id="tanggal_faktur" name="tanggal_faktur" required>
                    </div>
                    <div class="form-group">
                        <label for="no_faktur" class="font-weight-semibold">Nomor faktur</label>
                        <input type="text" class="form-control form-control-lg" id="no_faktur" name="no_faktur" placeholder="Misal: INV-2025-001" value="{{ draft_purchase_invoice }}" required>
                        <div id="fakturFeedback" class="invoice-feedback mt-2">
                            <i class="icon fas fa-info-circle"></i>
                            <span class="text">Pastikan nomor faktur unik.</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jenis_pembayaran" class="font-weight-semibold">Jenis pembayaran</label>
                        <select id="jenis_pembayaran" name="jenis_pembayaran" class="custom-select custom-select-lg">
                            <option value="Tunai">Tunai</option>
                            <option value="Tempo">Tempo</option>
                            <option value="Transfer">Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="tempo-due-date-group" style="display: none;">
                        <label for="tempo_due_date" class="font-weight-semibold">Jatuh tempo</label>
                        <input type="date" class="form-control form-control-lg" id="tempo_due_date" name="tempo_due_date">
                        <small class="text-muted">Wajib diisi untuk pembayaran tempo.</small>
                    </div>
                    <div class="form-group" id="transfer-bank-group" style="display: none;">
                        <label for="transfer_bank" class="font-weight-semibold">Bank transfer</label>
                        <input type="text" class="form-control form-control-lg" id="transfer_bank" name="transfer_bank" placeholder="Misal: BCA">
                    </div>
                    <div class="form-group" id="transfer-ref-group" style="display: none;">
                        <label for="transfer_reference" class="font-weight-semibold">No referensi transfer</label>
                        <input type="text" class="form-control form-control-lg" id="transfer_reference" name="transfer_reference" placeholder="Wajib diisi">
                    </div>
                    <div class="form-group">
                        <label for="supplier_id" class="font-weight-semibold">Supplier</label>
                        <select id="supplier_id" name="supplier" class="custom-select custom-select-lg" required>
                            <option value="">-- Pilih supplier --</option>
                            {% for supplier in supplier_payload %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-footer bg-light border-0">
                    <div id="supplier-meta" class="small text-muted">
                        Pilih supplier untuk melihat kontak, alamat, dan catatan lainnya.
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4 data-panel">
                <div class="card-header bg-white border-0">
                    <h2 class="h5 font-weight-bold mb-0">Data Barang</h2>
                    <small class="text-muted">Isi detail barang kemudian tekan tombol di bawah untuk memasukkan ke tabel.</small>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="font-weight-semibold">Cari produk</label>
                        <div class="position-relative">
                            <input type="text" class="form-control form-control-lg" id="item_product_search" placeholder="Ketik nama, kode, atau SKU" autocomplete="off">
                            <div class="product-suggestions shadow-sm" id="product-suggestion-box" hidden></div>
                        </div>
                        <small class="text-muted">Pilih hasil pencarian untuk mengisi otomatis kode, nama, kategori, satuan, dan harga.</small>
                    </div>
                    <div class="entry-grid">
                        <div class="form-group">
                            <label for="item_kode">Kode barang</label>
                            <input type="text" class="form-control" id="item_kode" placeholder="Wajib isi">
                        </div>
                        <div class="form-group">
                            <label for="item_nama">Nama barang</label>
                            <input type="text" class="form-control" id="item_nama" placeholder="Nama produk">
                        </div>
                        <div class="form-group">
                            <label for="item_kategori">Kategori</label>
                            <input type="text" class="form-control" id="item_kategori" placeholder="Kategori">
                        </div>
                        <div class="form-group">
                            <label for="item_satuan">Satuan</label>
                            <input type="text" class="form-control" id="item_satuan" placeholder="Misal: Kg, Pcs">
                        </div>
                        <div class="form-group">
                            <label for="item_qty">Jumlah</label>
                            <input type="number" class="form-control" id="item_qty" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="item_harga_beli">Harga beli</label>
                            <input type="text" class="form-control" id="item_harga_beli" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="item_diskon">Diskon (%)</label>
                            <input type="number" class="form-control" id="item_diskon" min="0" max="100" step="0.5" value="0">
                        </div>
                        <div class="form-group">
                            <label for="item_pajak">Pajak (%)</label>
                            <input type="number" class="form-control" id="item_pajak" min="0" step="0.5" value="{{ default_purchase_tax }}">
                        </div>
                        <div class="form-group">
                            <label for="item_harga_jual">Harga jual</label>
                            <input type="text" class="form-control" id="item_harga_jual" placeholder="Opsional">
                        </div>
                        <div class="form-group">
                            <label for="item_exp_date">Tanggal expired</label>
                            <input type="date" class="form-control" id="item_exp_date">
                        </div>
                        <div class="form-group">
                            <label for="item_hpp_preview">HPP (otomatis)</label>
                            <input type="text" class="form-control" id="item_hpp_preview" readonly placeholder="Rp 0">
                        </div>
                    </div>
                    <div class="entry-actions mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-items">
                            <i class="fas fa-undo mr-1"></i>Bersihkan daftar
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-item">
                            <i class="fas fa-save mr-1"></i><span id="add-item-label">Tambah ke tabel</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h3 class="h6 font-weight-bold mb-0">Daftar barang dibeli</h3>
                    <span class="badge badge-light text-uppercase">Realtime</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-modern table-hover mb-0" id="items-table">
                            <thead class="thead-light">
                                <tr>
                                    <th class="text-center">No</th>
                                    <th>Kode Barang</th>
                                    <th>Nama Barang</th>
                                    <th>Satuan</th>
                                    <th class="text-center">Jumlah</th>
                                    <th class="text-right">Harga Beli</th>
                                    <th class="text-right">Diskon</th>
                                    <th class="text-right">Pajak</th>
                                    <th class="text-right">HPP</th>
                                    <th class="text-right">Total</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body"></tbody>
                        </table>
                    </div>
                    <div id="items-empty-state" class="empty-state text-center py-4">
                        <p class="mb-0 text-muted">Belum ada barang dalam daftar. Lengkapi data barang lalu tekan <strong>Tambah ke tabel</strong>.</p>
                    </div>
                    <div class="table-footer d-flex justify-content-between align-items-center px-4 py-3 border-top">
                        <span class="text-muted">Grand total</span>
                        <span class="h5 font-weight-bold mb-0 text-primary" id="table-grand-total">Rp 0</span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="h6 font-weight-bold mb-3">Ringkasan biaya</h3>
                    <div class="summary-row d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Total item</span>
                        <span class="font-weight-semibold" id="summary-items">0</span>
                    </div>
                    <div class="summary-row d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Total diskon</span>
                        <span class="font-weight-semibold text-danger" id="summary-discount">Rp 0</span>
                    </div>
                    <div class="summary-row d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Total pajak</span>
                        <span class="font-weight-semibold text-info" id="summary-tax">Rp 0</span>
                    </div>
                    <div class="summary-row grand-total d-flex justify-content-between align-items-center pt-2 mt-2 border-top">
                        <span class="font-weight-bold text-uppercase">Total pembelian</span>
                        <span class="h4 font-weight-bold mb-0 text-primary" id="summary-grand">Rp 0</span>
                    </div>
                </div>
            </div>

            <div class="text-right mb-5">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save mr-2"></i>Simpan Pembelian
                </button>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="h6 font-weight-bold mb-3">Insight pembelian</h3>
                {% set badge_map = {'warning': 'badge-warning', 'info': 'badge-info', 'success': 'badge-success', 'secondary': 'badge-secondary'} %}
                <ul class="list-unstyled mb-0">
                    {% for insight in purchase_insights %}
                        <li class="mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="font-weight-semibold">{{ insight.title }}</span>
                                <span class="badge badge-pill {{ badge_map.get(insight.status, 'badge-secondary') }}">
                                    {% if insight.type == 'currency' %}
                                        {{ ('Rp {:,.0f}'.format(insight.value)).replace(',', '.') }}
                                    {% elif insight.type == 'count' %}
                                        {{ '{:,}'.format(insight.value).replace(',', '.') }}
                                    {% else %}
                                        {{ insight.value }}
                                    {% endif %}
                                </span>
                            </div>
                            <p class="small text-muted mb-0">{{ insight.description }}</p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="h6 font-weight-bold mb-3">Faktur terbaru</h3>
                {% if recent_purchases %}
                    <ul class="list-group list-group-flush">
                        {% for purchase in recent_purchases %}
                            <li class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="font-weight-semibold">{{ purchase.no_faktur }}</div>
                                        <small class="text-muted d-block">{{ purchase.tanggal }} • {{ purchase.supplier }}</small>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-weight-semibold text-dark">
                                            {{ ('Rp {:,.0f}'.format(purchase.total)).replace(',', '.') }}
                                        </div>
                                        <small class="text-muted">{{ purchase.items }} item</small>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="small text-muted mb-0">Belum ada riwayat pembelian tercatat.</p>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="h6 font-weight-bold mb-3">Tips restock</h3>
                <ul class="small text-muted pl-3 mb-0">
                    <li>Gunakan kolom diskon & pajak untuk melihat HPP secara akurat.</li>
                    <li>Catat tanggal kedaluwarsa agar persediaan tertata dan promo mudah disusun.</li>
                    <li>Nomor faktur unik memudahkan pencarian bukti transaksi.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="supplier-data">{{ supplier_lookup|tojson }}</script>
<script type="application/json" id="product-data">{{ product_payload|tojson }}</script>

<style>
    .hero-card {
        border-radius: 20px;
        padding: 2.5rem 2rem;
    }
    .hero-card .btn {
        border-radius: 999px;
    }
    .hero-meta .badge {
        letter-spacing: 0.08em;
    }
    .text-white-75 {
        color: rgba(255, 255, 255, 0.75) !important;
    }
    .font-weight-semibold {
        font-weight: 600;
    }
    .data-panel {
        border-radius: 18px;
    }
    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        grid-gap: 1rem;
    }
    .entry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        grid-gap: 0.85rem;
    }
    .entry-grid .form-control {
        border-radius: 10px;
    }
    .entry-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    .entry-actions .btn {
        min-width: 150px;
    }
    .product-suggestions {
        position: absolute;
        top: calc(100% + 0.4rem);
        left: 0;
        right: 0;
        background: #fff;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 18px 35px rgba(15, 23, 42, 0.14);
        max-height: 260px;
        overflow-y: auto;
        z-index: 50;
    }
    .product-suggestions[hidden] {
        display: none;
    }
    .product-suggestions button {
        width: 100%;
        background: none;
        border: 0;
        padding: 0.6rem 0.9rem;
        text-align: left;
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #111827;
    }
    .product-suggestions button:hover,
    .product-suggestions button:focus {
        background: rgba(37, 99, 235, 0.08);
        outline: none;
    }
    .product-suggestions small {
        color: #6b7280;
        margin-left: 0.5rem;
    }
    #items-table tbody tr td {
        vertical-align: middle;
    }
    #items-empty-state {
        border-top: 1px dashed rgba(15, 23, 42, 0.1);
        border-bottom: 1px dashed rgba(15, 23, 42, 0.1);
    }
    .table-footer {
        background: rgba(248, 250, 252, 0.9);
    }
    .invoice-feedback {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
        background: rgba(15, 23, 42, 0.05);
        color: #475569;
        transition: background 0.2s ease, color 0.2s ease;
    }
    .invoice-feedback .icon {
        font-size: 0.9rem;
    }
    .invoice-feedback.is-checking {
        background: rgba(59, 130, 246, 0.15);
        color: #1d4ed8;
    }
    .invoice-feedback.is-success {
        background: rgba(16, 185, 129, 0.18);
        color: #047857;
    }
    .invoice-feedback.is-error {
        background: rgba(239, 68, 68, 0.18);
        color: #b91c1c;
    }
    .summary-row {
        font-size: 0.95rem;
    }
    .grand-total .h4 {
        font-size: 1.5rem;
    }
    .empty-state {
        background: rgba(15, 23, 42, 0.02);
        border-radius: 0 0 1rem 1rem;
    }
    @media (max-width: 576px) {
        .hero-card {
            border-radius: 16px;
            padding: 2rem 1.5rem;
        }
        .data-grid {
            grid-template-columns: 1fr;
        }
        .entry-grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const supplierDataScript = document.getElementById('supplier-data');
    const productDataScript = document.getElementById('product-data');
    const supplierMap = supplierDataScript ? JSON.parse(supplierDataScript.textContent || '{}') : {};
    const products = productDataScript ? JSON.parse(productDataScript.textContent || '[]') : [];

    const supplierSelect = document.getElementById('supplier_id');
    const supplierMeta = document.getElementById('supplier-meta');
    const paymentSelect = document.getElementById('jenis_pembayaran');
    const tempoDueDateGroup = document.getElementById('tempo-due-date-group');
    const tempoDueDateInput = document.getElementById('tempo_due_date');
    const transferBankGroup = document.getElementById('transfer-bank-group');
    const transferBankInput = document.getElementById('transfer_bank');
    const transferRefGroup = document.getElementById('transfer-ref-group');
    const transferRefInput = document.getElementById('transfer_reference');
    const invoiceInput = document.getElementById('no_faktur');
    const invoiceFeedback = document.getElementById('fakturFeedback');
    const tanggalInput = document.getElementById('tanggal_faktur');
    const formElement = document.getElementById('pembelianForm');
    const csrfTokenValue = document.querySelector('input[name="csrf_token"]')?.value || '';
    const defaultPurchaseTax = Number({{ default_purchase_tax|tojson }}) || 0;

    const entry = {
        search: document.getElementById('item_product_search'),
        suggestionBox: document.getElementById('product-suggestion-box'),
        kode: document.getElementById('item_kode'),
        nama: document.getElementById('item_nama'),
        kategori: document.getElementById('item_kategori'),
        satuan: document.getElementById('item_satuan'),
        qty: document.getElementById('item_qty'),
        hargaBeli: document.getElementById('item_harga_beli'),
        diskon: document.getElementById('item_diskon'),
        pajak: document.getElementById('item_pajak'),
        hargaJual: document.getElementById('item_harga_jual'),
        expDate: document.getElementById('item_exp_date'),
        hpp: document.getElementById('item_hpp_preview')
    };

    const addItemButton = document.getElementById('add-item');
    const addItemLabel = document.getElementById('add-item-label');
    const clearItemsButton = document.getElementById('clear-items');
    const itemsTableBody = document.getElementById('items-table-body');
    const itemsEmptyState = document.getElementById('items-empty-state');
    const tableGrandTotalEl = document.getElementById('table-grand-total');
    const summaryEls = {
        items: document.getElementById('summary-items'),
        discount: document.getElementById('summary-discount'),
        tax: document.getElementById('summary-tax'),
        grand: document.getElementById('summary-grand')
    };

    const state = {
        items: [],
        editingIndex: null
    };

    let invoiceValid = false;
    let invoiceCheckTimeout = null;
    let suggestionTimer = null;

    const itemFields = [
        entry.search,
        entry.kode,
        entry.nama,
        entry.kategori,
        entry.satuan,
        entry.qty,
        entry.hargaBeli,
        entry.diskon,
        entry.pajak,
        entry.hargaJual,
        entry.expDate
    ].filter(Boolean);
    const paymentFields = [
        tempoDueDateInput,
        transferBankInput,
        transferRefInput
    ].filter(Boolean);
    const navigationOrder = [
        tanggalInput,
        invoiceInput,
        paymentSelect,
        ...paymentFields,
        supplierSelect,
        ...itemFields
    ].filter(Boolean);
    const itemFieldSet = new Set(itemFields);

function sanitizeNumericString(value) {
        if (value === null || value === undefined) {
            return '';
        }
        let str = value.toString().trim();
        if (!str) {
            return '';
        }
        str = str.replace(/[^0-9,.-]/g, '');
        const isNegative = str.startsWith('-');
        if (isNegative) {
            str = '-' + str.slice(1).replace(/-/g, '');
        } else {
            str = str.replace(/-/g, '');
        }
        if (str.includes(',')) {
            str = str.replace(/\./g, '').replace(/,/g, '.');
        }
        if (str.includes('.')) {
            const firstDot = str.indexOf('.');
            const lastDot = str.lastIndexOf('.');
            if (firstDot !== lastDot) {
                str = str.replace(/\./g, '');
            } else {
                const decimalPart = str.slice(lastDot + 1);
                if (!decimalPart || (decimalPart.length === 3 && /^\d{3}$/.test(decimalPart))) {
                    str = str.replace(/\./g, '');
                }
            }
        }
        return str;
    }

    function parseNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatCurrency(value) {
        const formatter = new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        });
        return formatter.format(value || 0);
    }

    function formatNumberInput(value) {
        const raw = parseNumber(sanitizeNumericString(value));
        return raw ? raw.toLocaleString('id-ID') : '';
    }

    function calculateMetrics(item) {
        const qty = parseNumber(item.jumlah);
        const price = parseNumber(item.harga_beli);
        const discountRate = parseNumber(item.diskon) / 100;
        const taxRate = parseNumber(item.pajak) / 100;
        const base = qty * price;
        const discountValue = base * discountRate;
        const taxable = base - discountValue;
        const taxValue = taxable * taxRate;
        const total = taxable + taxValue;
        const hpp = qty ? total / qty : total;
        return { base, discountValue, taxValue, total, hpp };
    }

    function updateEntryHPPPreview() {
        if (!entry.hpp) {
            return;
        }
        const qty = Math.max(1, parseNumber(entry.qty.value));
        const hargaBeli = parseNumber(sanitizeNumericString(entry.hargaBeli.value));
        const diskon = Math.max(0, parseNumber(entry.diskon.value));
        const pajak = Math.max(0, parseNumber(entry.pajak.value));
        const metrics = calculateMetrics({ jumlah: qty, harga_beli: hargaBeli, diskon, pajak });
        entry.hpp.value = formatCurrency(metrics.hpp);
    }

    function updateSupplierMeta() {
        if (!supplierMeta) {
            return;
        }
        const selected = supplierMap[supplierSelect.value];
        if (!selected) {
            supplierMeta.textContent = 'Pilih supplier untuk melihat kontak, alamat, dan catatan lainnya.';
            return;
        }
        supplierMeta.innerHTML = `
            <div class="d-flex flex-column">
                <span class="font-weight-semibold text-dark">${selected.name || '-'}</span>
                <span>${selected.address || 'Alamat belum tercatat'}</span>
                <span>T: ${selected.phone || '-'}</span>
                <span>Email: ${selected.email || '-'}</span>
            </div>
        `;
    }

    function setInvoiceState(stateName, message) {
        invoiceFeedback.classList.remove('is-checking', 'is-success', 'is-error');
        invoiceFeedback.querySelector('.text').textContent = message;
        if (stateName === 'checking') {
            invoiceFeedback.classList.add('is-checking');
        } else if (stateName === 'success') {
            invoiceFeedback.classList.add('is-success');
        } else if (stateName === 'error') {
            invoiceFeedback.classList.add('is-error');
        }
    }

    function checkInvoiceUniqueness() {
        const value = invoiceInput.value.trim();
        if (!value) {
            invoiceValid = false;
            setInvoiceState('info', 'Nomor faktur wajib diisi.');
            return;
        }
        setInvoiceState('checking', 'Memeriksa ketersediaan nomor faktur...');
        fetch('{{ url_for("main.check_no_faktur") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfTokenValue
            },
            body: JSON.stringify({ no_faktur: value })
        })
            .then(response => response.json().then(body => ({ ok: response.ok, body })))
            .then(({ ok, body }) => {
                const isAvailable = typeof body.available === 'boolean'
                    ? body.available
                    : !body.exists;
                if (ok && isAvailable) {
                    invoiceValid = true;
                    setInvoiceState('success', body.message || 'Nomor faktur tersedia.');
                } else {
                    invoiceValid = false;
                    setInvoiceState('error', body.message || 'Nomor faktur sudah digunakan.');
                }
            })
            .catch(() => {
                invoiceValid = false;
                setInvoiceState('error', 'Gagal memeriksa nomor faktur.');
            });
    }

function resetEntryForm() {
        entry.search.value = '';
        entry.kode.value = '';
        entry.nama.value = '';
        entry.kategori.value = '';
        if (entry.satuan) {
            entry.satuan.value = '';
        }
        entry.qty.value = 1;
        entry.hargaBeli.value = '';
        entry.diskon.value = 0;
        entry.pajak.value = defaultPurchaseTax;
        entry.hargaJual.value = '';
        entry.expDate.value = '';
        if (entry.hpp) {
            entry.hpp.value = 'Rp 0';
        }
        state.editingIndex = null;
        addItemLabel.textContent = 'Tambah ke tabel';
        addItemButton.classList.remove('btn-success');
        updateEntryHPPPreview();
    }

    function collectEntryValues() {
        const kode = entry.kode.value.trim();
        const nama = entry.nama.value.trim();
        const kategori = entry.kategori.value.trim();
        const satuan = entry.satuan ? entry.satuan.value.trim() : '';
        const qty = Math.max(1, parseNumber(entry.qty.value));
        const hargaBeli = parseNumber(sanitizeNumericString(entry.hargaBeli.value));
        const diskon = Math.max(0, parseNumber(entry.diskon.value));
        const pajak = Math.max(0, parseNumber(entry.pajak.value));
        const hargaJual = parseNumber(sanitizeNumericString(entry.hargaJual.value));
        const expDate = entry.expDate.value || null;

        if (!kode || !nama) {
            alert('Kode dan nama barang wajib diisi.');
            return null;
        }
        const item = {
            kode_barang: kode,
            nama_barang: nama,
            kategori,
            satuan,
            jumlah: qty,
            harga_beli: hargaBeli,
            diskon,
            pajak,
            harga_jual: hargaJual,
            exp_date: expDate
        };
        const metrics = calculateMetrics(item);
        item.hpp = metrics.hpp;
        return item;
    }

    function renderItemsTable() {
        itemsTableBody.innerHTML = '';
        if (!state.items.length) {
            itemsEmptyState.hidden = false;
        } else {
            itemsEmptyState.hidden = true;
        }
        let totalQty = 0;
        let totalDiscount = 0;
        let totalTax = 0;
        let totalCost = 0;

        state.items.forEach((item, index) => {
            const metrics = calculateMetrics(item);
            totalQty += parseNumber(item.jumlah);
            totalDiscount += metrics.discountValue;
            totalTax += metrics.taxValue;
            totalCost += metrics.total;
            const hppValue = item.hpp != null ? item.hpp : metrics.hpp;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center align-middle">${index + 1}</td>
                <td class="align-middle">${item.kode_barang}</td>
                <td class="align-middle">${item.nama_barang}</td>
                <td class="align-middle">${item.satuan || '-'}</td>
                <td class="text-center align-middle">${item.jumlah}</td>
                <td class="text-right align-middle">${formatCurrency(item.harga_beli)}</td>
                <td class="text-right align-middle">${item.diskon}%</td>
                <td class="text-right align-middle">${item.pajak}%</td>
                <td class="text-right align-middle">${formatCurrency(hppValue)}</td>
                <td class="text-right align-middle">${formatCurrency(metrics.total)}</td>
                <td class="text-center align-middle">
                    <button type="button" class="btn btn-link text-secondary p-1" data-action="edit" data-index="${index}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-link text-danger p-1" data-action="remove" data-index="${index}" title="Hapus">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            itemsTableBody.appendChild(tr);
        });

        summaryEls.items.textContent = totalQty.toString();
        summaryEls.discount.textContent = formatCurrency(totalDiscount);
        summaryEls.tax.textContent = formatCurrency(totalTax);
        summaryEls.grand.textContent = formatCurrency(totalCost);
        tableGrandTotalEl.textContent = formatCurrency(totalCost);
    }

    function handleAddItem() {
        const item = collectEntryValues();
        if (!item) {
            return;
        }
        const kode = item.kode_barang;
        const mergeItems = (baseItem, incomingItem) => {
            const merged = { ...baseItem };
            merged.jumlah = parseNumber(baseItem.jumlah) + parseNumber(incomingItem.jumlah);
            if (!merged.exp_date && incomingItem.exp_date) {
                merged.exp_date = incomingItem.exp_date;
            }
            return merged;
        };

        if (state.editingIndex !== null) {
            const currentIndex = state.editingIndex;
            const duplicateIndex = state.items.findIndex(
                (existing, idx) => idx !== currentIndex && existing.kode_barang === kode
            );
            if (duplicateIndex !== -1) {
                state.items[duplicateIndex] = mergeItems(state.items[duplicateIndex], item);
                state.items.splice(currentIndex, 1);
            } else {
                state.items[currentIndex] = item;
            }
        } else {
            const existingIndex = state.items.findIndex(
                existing => existing.kode_barang === kode
            );
            if (existingIndex !== -1) {
                state.items[existingIndex] = mergeItems(state.items[existingIndex], item);
            } else {
                state.items.push(item);
            }
        }
        state.editingIndex = null;
        addItemLabel.textContent = 'Tambah ke tabel';
        addItemButton.classList.remove('btn-success');
        renderItemsTable();
        resetEntryForm();
        entry.search.focus();
    }

    function focusByOffset(currentEl, offset) {
        const currentIndex = navigationOrder.indexOf(currentEl);
        if (currentIndex === -1) {
            return;
        }
        let nextIndex = currentIndex + offset;
        if (nextIndex < 0) {
            nextIndex = 0;
        }
        if (nextIndex >= navigationOrder.length) {
            nextIndex = navigationOrder.length - 1;
        }
        while (nextIndex >= 0 && nextIndex < navigationOrder.length) {
            const nextEl = navigationOrder[nextIndex];
            const isVisible = nextEl && nextEl.offsetParent !== null;
            if (nextEl && !nextEl.disabled && isVisible && typeof nextEl.focus === 'function') {
                nextEl.focus();
                break;
            }
            nextIndex += offset > 0 ? 1 : -1;
        }
    }

    function handleKeyboardAdvance(event) {
        if (event.key !== 'Enter' && event.key !== 'NumpadEnter') {
            return;
        }
        if (event.isComposing) {
            return;
        }
        const target = event.target;
        if (!target || !navigationOrder.includes(target)) {
            return;
        }
        if (event.ctrlKey || event.metaKey) {
            if (itemFieldSet.has(target)) {
                event.preventDefault();
                handleAddItem();
            }
            return;
        }
        if (itemFieldSet.has(target) && target === entry.expDate && !event.shiftKey) {
            event.preventDefault();
            handleAddItem();
            return;
        }
        event.preventDefault();
        focusByOffset(target, event.shiftKey ? -1 : 1);
    }

    function updatePaymentFields() {
        const method = paymentSelect ? paymentSelect.value : 'Tunai';
        if (tempoDueDateGroup) {
            tempoDueDateGroup.style.display = method === 'Tempo' ? '' : 'none';
            if (method !== 'Tempo' && tempoDueDateInput) {
                tempoDueDateInput.value = '';
            }
        }
        if (transferBankGroup) {
            transferBankGroup.style.display = method === 'Transfer' ? '' : 'none';
            if (method !== 'Transfer' && transferBankInput) {
                transferBankInput.value = '';
            }
        }
        if (transferRefGroup) {
            transferRefGroup.style.display = method === 'Transfer' ? '' : 'none';
            if (method !== 'Transfer' && transferRefInput) {
                transferRefInput.value = '';
            }
        }
    }

    function handleTableAction(event) {
        const button = event.target.closest('button[data-action]');
        if (!button) {
            return;
        }
        const index = Number(button.dataset.index);
        if (!Number.isFinite(index)) {
            return;
        }
        if (button.dataset.action === 'remove') {
            state.items.splice(index, 1);
            renderItemsTable();
            resetEntryForm();
        } else if (button.dataset.action === 'edit') {
            const item = state.items[index];
            entry.kode.value = item.kode_barang;
            entry.nama.value = item.nama_barang;
            entry.kategori.value = item.kategori;
            if (entry.satuan) {
                entry.satuan.value = item.satuan || '';
            }
            entry.qty.value = item.jumlah;
            entry.hargaBeli.value = formatNumberInput(item.harga_beli);
            entry.diskon.value = item.diskon;
            entry.pajak.value = item.pajak;
            entry.hargaJual.value = formatNumberInput(item.harga_jual);
            entry.expDate.value = item.exp_date || '';
            if (entry.hpp) {
                entry.hpp.value = formatCurrency(item.hpp != null ? item.hpp : calculateMetrics(item).hpp);
            }
            state.editingIndex = index;
            addItemLabel.textContent = 'Perbarui item';
            addItemButton.classList.add('btn-success');
            entry.kode.focus();
            updateEntryHPPPreview();
        }
    }

    function clearItemList() {
        state.items = [];
        state.editingIndex = null;
        renderItemsTable();
        resetEntryForm();
    }

    function renderSuggestions(matches) {
        if (!entry.suggestionBox) {
            return;
        }
        entry.suggestionBox.innerHTML = '';
        if (!matches.length) {
            entry.suggestionBox.hidden = true;
            return;
        }
        matches.slice(0, 6).forEach(product => {
            const button = document.createElement('button');
            button.type = 'button';
            button.innerHTML = `<span>${product.nama || product.kode || 'Produk tanpa nama'}</span><small>${product.kode || '-'}${product.sku ? ' • ' + product.sku : ''}</small>`;
            button.addEventListener('click', () => {
                entry.search.value = product.nama || product.kode || '';
                entry.kode.value = product.kode || '';
                entry.nama.value = product.nama || '';
                entry.kategori.value = product.kategori || '';
                entry.hargaBeli.value = formatNumberInput(product.harga_beli);
                entry.hargaJual.value = formatNumberInput(product.harga_jual);
                if (entry.satuan) {
                    entry.satuan.value = product.satuan || '';
                }
                entry.search.focus();
                entry.suggestionBox.hidden = true;
                updateEntryHPPPreview();
            });
            entry.suggestionBox.appendChild(button);
        });
        entry.suggestionBox.hidden = false;
    }

    function handleProductSearch() {
        const query = entry.search.value.trim().toLowerCase();
        if (suggestionTimer) {
            clearTimeout(suggestionTimer);
        }
        if (!query) {
            entry.suggestionBox.hidden = true;
            return;
        }
        suggestionTimer = setTimeout(() => {
            const matches = products.filter(product => {
                const name = (product.nama || '').toLowerCase();
                const kode = (product.kode || '').toLowerCase();
                const sku = (product.sku || '').toLowerCase();
                return name.includes(query) || kode.includes(query) || sku.includes(query);
            });
            renderSuggestions(matches);
        }, 200);
    }

    function submitForm(event) {
        event.preventDefault();
        if (!invoiceValid) {
            alert('Validasi nomor faktur masih berlangsung atau gagal. Mohon cek kembali.');
            return;
        }
        if (!state.items.length) {
            alert('Tambahkan minimal satu barang ke dalam tabel.');
            return;
        }
        const payload = {
            tanggal_faktur: tanggalInput.value,
            no_faktur: invoiceInput.value.trim(),
            supplier: supplierSelect.value,
            jenis_pembayaran: paymentSelect ? paymentSelect.value.trim() : 'Tunai',
            due_date: tempoDueDateInput ? tempoDueDateInput.value : '',
            payment_bank: transferBankInput ? transferBankInput.value.trim() : '',
            payment_reference: transferRefInput ? transferRefInput.value.trim() : '',
            items: state.items.map(item => ({
                kode_barang: item.kode_barang,
                nama_barang: item.nama_barang,
                kategori: item.kategori,
                satuan: item.satuan,
                jumlah: item.jumlah,
                harga_beli: item.harga_beli,
                diskon: item.diskon,
                pajak: item.pajak,
                harga_jual: item.harga_jual,
                exp_date: item.exp_date,
                hpp: item.hpp
            }))
        };

        if (!payload.tanggal_faktur || !payload.no_faktur || !payload.supplier) {
            alert('Lengkapi data faktur dan pilih supplier.');
            return;
        }

        if (!payload.jenis_pembayaran) {
            alert('Pilih jenis pembayaran terlebih dahulu.');
            return;
        }
        if (payload.jenis_pembayaran === 'Tempo' && !payload.due_date) {
            alert('Tanggal jatuh tempo wajib diisi untuk pembayaran tempo.');
            if (tempoDueDateInput) {
                tempoDueDateInput.focus();
            }
            return;
        }
        if (payload.jenis_pembayaran === 'Transfer' && !payload.payment_reference) {
            alert('Nomor referensi transfer wajib diisi.');
            if (transferRefInput) {
                transferRefInput.focus();
            }
            return;
        }

        fetch('{{ url_for("main.pembelian") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfTokenValue
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json().then(body => ({ ok: response.ok, body })))
            .then(({ ok, body }) => {
                if (ok && body.success) {
                    alert(`${body.message} Total biaya: ${formatCurrency(body.total_biaya)}`);
                    window.location.reload();
                } else {
                    alert(body.message || 'Gagal menyimpan pembelian.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Terjadi kesalahan saat menyimpan pembelian.');
            });
    }

    supplierSelect.addEventListener('change', updateSupplierMeta);
    updateSupplierMeta();

    invoiceInput.addEventListener('input', function () {
        invoiceValid = false;
        setInvoiceState('info', 'Memeriksa nomor faktur...');
        if (invoiceCheckTimeout) {
            clearTimeout(invoiceCheckTimeout);
        }
        invoiceCheckTimeout = setTimeout(checkInvoiceUniqueness, 600);
    });
    if (invoiceInput.value.trim()) {
        checkInvoiceUniqueness();
    }

    if (paymentSelect) {
        paymentSelect.addEventListener('change', updatePaymentFields);
        updatePaymentFields();
    }

    navigationOrder.forEach(field => {
        field.addEventListener('keydown', handleKeyboardAdvance);
    });

    addItemButton.addEventListener('click', handleAddItem);
    clearItemsButton.addEventListener('click', clearItemList);
    itemsTableBody.addEventListener('click', handleTableAction);
    formElement.addEventListener('submit', submitForm);

    ['qty', 'hargaBeli', 'diskon', 'pajak'].forEach(key => {
        if (entry[key]) {
            entry[key].addEventListener('input', updateEntryHPPPreview);
            entry[key].addEventListener('blur', updateEntryHPPPreview);
        }
    });

    if (entry.hargaBeli) {
        entry.hargaBeli.addEventListener('blur', function () {
            this.value = formatNumberInput(this.value);
        });
    }
    if (entry.hargaJual) {
        entry.hargaJual.addEventListener('blur', function () {
            this.value = formatNumberInput(this.value);
        });
    }
    entry.search.addEventListener('input', handleProductSearch);
    document.addEventListener('click', function (event) {
        if (!entry.suggestionBox.contains(event.target) && event.target !== entry.search) {
            entry.suggestionBox.hidden = true;
        }
    });

    renderItemsTable();
    updateEntryHPPPreview();
});
</script>
{% endblock %}
