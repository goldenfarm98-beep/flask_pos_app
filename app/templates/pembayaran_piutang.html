{% extends "base.html" %}

{% block title %}Pembayaran Piutang{% endblock %}

{% macro format_currency(value) -%}
    {{ ('Rp {:,.0f}'.format(value or 0)).replace(',', '.') }}
{%- endmacro %}
{% macro format_number(value) -%}
    {{ '{:,}'.format(value or 0).replace(',', '.') }}
{%- endmacro %}

{% block content %}
<section class="receivable-payment">
    <div class="card shadow-sm border-0 mb-4 payment-hero">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center">
            <div class="flex-fill pr-lg-4">
                <p class="eyebrow text-uppercase mb-2">Utilitas</p>
                <h1 class="display-5 mb-2 text-navy">Pembayaran Piutang</h1>
                <p class="mb-0 text-muted">Cari piutang tempo, catat pembayaran, dan pantau sisa tagihan pelanggan.</p>
            </div>
            <div class="text-lg-right mt-4 mt-lg-0">
                <small class="text-uppercase text-muted d-block">Total piutang terbuka</small>
                <div class="h3 font-weight-bold mb-1">{{ format_currency(total_outstanding) }}</div>
                <span class="badge badge-pill badge-soft-danger">{{ format_number(pagination.total_records) }} faktur aktif</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                <div>
                    <h2 class="h5 font-weight-bold mb-1">Pencarian data piutang</h2>
                    <p class="small text-muted mb-0">Gunakan rentang tanggal transaksi untuk mempersempit daftar piutang.</p>
                </div>
                <a href="{{ url_for('main.pembayaran_piutang') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-sync-alt mr-1"></i>Reset
                </a>
            </div>
            <form method="get" class="receivable-filter">
                <div class="form-row">
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Mulai</label>
                        <input type="date" class="form-control" name="start_date" value="{{ filter_values.start_date }}">
                    </div>
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Sampai</label>
                        <input type="date" class="form-control" name="end_date" value="{{ filter_values.end_date }}">
                    </div>
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Cari</label>
                        <input type="text" class="form-control" name="search" placeholder="Faktur / pelanggan / sales" value="{{ filter_values.search }}">
                    </div>
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Pelanggan</label>
                        <select class="custom-select" name="pelanggan">
                            <option value="">Semua pelanggan</option>
                            {% for pelanggan in customer_options %}
                                <option value="{{ pelanggan.id }}" {% if filter_values.pelanggan == pelanggan.id %}selected{% endif %}>
                                    {{ pelanggan.nama }} ({{ pelanggan.pelanggan_id }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Sales</label>
                        <select class="custom-select" name="sales">
                            <option value="">Semua sales</option>
                            {% for sales in sales_options %}
                                <option value="{{ sales.id }}" {% if filter_values.sales == sales.id %}selected{% endif %}>
                                    {{ sales.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-lg-3 col-md-6 mb-3">
                        <label class="text-muted small text-uppercase">Per halaman</label>
                        <select name="per_page" class="custom-select">
                            {% for candidate in [10, 20, 30, 50] %}
                                <option value="{{ candidate }}" {% if per_page == candidate %}selected{% endif %}>{{ candidate }} data</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-lg-6 d-flex align-items-end justify-content-end mb-0">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter mr-1"></i>Terapkan filter
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <div>
                    <p class="eyebrow text-uppercase mb-1">Data piutang</p>
                    <h3 class="h5 mb-0">Daftar faktur tempo aktif</h3>
                </div>
                <span class="badge badge-pill badge-light">{{ format_number(pagination.total_records) }} faktur</span>
            </div>
            {% if filter_active %}
                <div class="alert alert-info py-2 px-3 small mb-3">
                    Filter aktif: periode {{ filter_values.start_date }} - {{ filter_values.end_date }}
                    {% if filter_values.search %}
                        â€¢ Kata kunci "{{ filter_values.search }}"
                    {% endif %}
                </div>
            {% endif %}
            {% if receivable_rows %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle receivable-table mb-0">
                        <thead class="text-uppercase small text-muted">
                            <tr>
                                <th>Tanggal</th>
                                <th>Pelanggan</th>
                                <th>No Faktur</th>
                                <th class="text-right">Jumlah Hutang</th>
                                <th class="text-right">Sudah Dibayar</th>
                                <th class="text-right">Kekurangan</th>
                                <th>Jatuh Tempo</th>
                                <th class="text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in receivable_rows %}
                                <tr>
                                    <td>
                                        <div class="font-weight-semibold">{{ format_date(row.sale_date) }}</div>
                                        <small class="text-muted">{{ row.sales_name }}</small>
                                    </td>
                                    <td>
                                        <div class="font-weight-semibold">{{ row.customer_name }}</div>
                                        <small class="text-muted">{{ row.customer_code }}</small>
                                    </td>
                                    <td>
                                        <div class="font-weight-semibold text-navy">{{ row.invoice }}</div>
                                    </td>
                                    <td class="text-right font-weight-semibold">{{ format_currency(row.total) }}</td>
                                    <td class="text-right">{{ format_currency(row.amount_paid) }}</td>
                                    <td class="text-right text-danger font-weight-semibold">{{ format_currency(row.outstanding) }}</td>
                                    <td>
                                        <div class="font-weight-semibold">
                                            {{ format_date(row.due_date) if row.due_date else '-' }}
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-primary open-payment-btn"
                                            data-action="open-payment"
                                            data-toggle="modal"
                                            data-target="#receivablePaymentModal"
                                            data-sale-id="{{ row.id }}"
                                            data-invoice="{{ row.invoice }}"
                                            data-customer="{{ row.customer_name }}"
                                            data-total="{{ row.total }}"
                                            data-paid="{{ row.amount_paid }}"
                                            data-outstanding="{{ row.outstanding }}"
                                            data-due="{{ row.due_date }}"
                                        >
                                            <i class="fas fa-coins mr-1"></i>Bayar
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <div>Belum ada piutang tempo sesuai filter.</div>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
        <p class="small text-muted mb-3 mb-md-0">
            Total {{ format_number(pagination.total_records) }} faktur - Halaman {{ pagination.page }} dari {{ pagination.total_pages }}
        </p>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ pagination.prev_url if pagination.prev_url else '#' }}">&laquo;</a>
                </li>
                {% for link in pagination.page_links %}
                    <li class="page-item {% if link.current %}active{% endif %}">
                        <a class="page-link" href="{{ link.url }}">{{ link.number }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ pagination.next_url if pagination.next_url else '#' }}">&raquo;</a>
                </li>
            </ul>
        </nav>
    </div>
</section>

<div class="modal fade" id="receivablePaymentModal" tabindex="-1" role="dialog" aria-labelledby="receivablePaymentModalLabel" aria-hidden="true" data-history-base="{{ url_for('main.pembayaran_piutang_history', sale_id=0) }}">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content payment-modal">
            <div class="modal-header border-0">
                <div>
                    <p class="eyebrow text-uppercase mb-1">Transaksi Pembayaran</p>
                    <h5 class="modal-title" id="receivablePaymentModalLabel">Pembayaran Piutang</h5>
                    <small class="text-muted">No Pembayaran: <span id="payment-number">-</span></small>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{{ url_for('main.pembayaran_piutang_bayar') }}" class="modal-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="sale_id" id="payment-sale-id" value="">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                <div class="payment-summary">
                    <div>
                        <small class="text-uppercase text-muted">Faktur</small>
                        <div class="font-weight-semibold" id="payment-invoice">-</div>
                    </div>
                    <div>
                        <small class="text-uppercase text-muted">Pelanggan</small>
                        <div class="font-weight-semibold" id="payment-customer">-</div>
                    </div>
                    <div>
                        <small class="text-uppercase text-muted">Sisa Tagihan</small>
                        <div class="font-weight-bold text-danger" id="payment-outstanding-display">Rp 0</div>
                    </div>
                </div>
                <div class="form-row mt-3">
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Jumlah Hutang</label>
                        <input type="text" class="form-control" id="payment-total-display" readonly>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Sudah Dibayar</label>
                        <input type="text" class="form-control" id="payment-paid-display" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Jenis Pembayaran</label>
                        <select class="custom-select" name="payment_method">
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Kartu">Kartu</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">No Referensi</label>
                        <input type="text" class="form-control" name="reference" placeholder="Opsional">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label class="text-muted small text-uppercase">Catatan</label>
                        <textarea class="form-control" name="note" rows="2" placeholder="Catatan pembayaran (opsional)"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Jumlah Bayar</label>
                        <input type="number" class="form-control" name="payment_amount" id="payment-amount" min="0" step="1000" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Kekurangan</label>
                        <input type="text" class="form-control" id="payment-remaining" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Kembali</label>
                        <input type="text" class="form-control" id="payment-change" readonly>
                    </div>
                    <div class="form-group col-md-6 d-flex align-items-center">
                        <div class="custom-control custom-checkbox mt-3">
                            <input type="checkbox" class="custom-control-input" id="toggle-due-date">
                            <label class="custom-control-label" for="toggle-due-date">Ubah deadline</label>
                        </div>
                    </div>
                </div>
                <div class="form-row" id="due-date-wrapper" style="display: none;">
                    <div class="form-group col-md-6">
                        <label class="text-muted small text-uppercase">Tanggal Jatuh Tempo Baru</label>
                        <input type="date" class="form-control" name="new_due_date" id="payment-due-date">
                        <input type="hidden" name="update_due" id="payment-update-due" value="0">
                    </div>
                </div>
                <div class="modal-footer border-0 px-0 pb-0">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check mr-1"></i>Bayar
                    </button>
                </div>
            </form>
            <div class="payment-history mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Riwayat cicilan</h6>
                    <span class="badge badge-pill badge-light" id="payment-history-count">0</span>
                </div>
                <div class="text-muted small" id="payment-history-empty">Belum ada pembayaran sebelumnya.</div>
                <div class="table-responsive" id="payment-history-table" hidden>
                    <table class="table table-sm mb-0">
                        <thead class="text-uppercase small text-muted">
                            <tr>
                                <th>Tanggal</th>
                                <th>Metode</th>
                                <th>No Ref</th>
                                <th>Catatan</th>
                                <th class="text-right">Nominal</th>
                                <th class="text-right">Dicatat</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-hero {
        border-radius: 18px;
        background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
    }
    .receivable-table thead th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #475569;
        border-top: none;
        background: #f8fafc;
    }
    .payment-modal {
        border-radius: 18px;
        border: none;
    }
    .payment-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
        background: #f8fafc;
        border-radius: 14px;
        padding: 0.85rem 1rem;
    }
    .payment-summary .text-danger {
        font-size: 1.1rem;
    }
    .payment-history {
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        padding-top: 1rem;
    }
    .payment-history table th {
        font-size: 0.7rem;
        letter-spacing: 0.04em;
    }
    .badge-soft-danger {
        background: rgba(220, 38, 38, 0.16);
        color: #b91c1c;
        font-weight: 600;
    }
    .pagination .page-link {
        border-radius: 999px;
        margin: 0 0.1rem;
    }
    .pagination .page-item.active .page-link {
        background: #2563eb;
        border-color: #2563eb;
    }
    @media (max-width: 768px) {
        .modal-dialog {
            margin: 1rem;
        }
    }
</style>

<script>
    (function () {
        const paymentModal = document.getElementById('receivablePaymentModal');
        if (!paymentModal) {
            return;
        }
        const numberEl = document.getElementById('payment-number');
        const invoiceEl = document.getElementById('payment-invoice');
        const customerEl = document.getElementById('payment-customer');
        const totalDisplay = document.getElementById('payment-total-display');
        const paidDisplay = document.getElementById('payment-paid-display');
        const outstandingDisplay = document.getElementById('payment-outstanding-display');
        const amountInput = document.getElementById('payment-amount');
        const remainingDisplay = document.getElementById('payment-remaining');
        const changeDisplay = document.getElementById('payment-change');
        const saleIdInput = document.getElementById('payment-sale-id');
        const historyBase = paymentModal.dataset.historyBase || '';
        const historyBody = document.getElementById('payment-history-body');
        const historyEmpty = document.getElementById('payment-history-empty');
        const historyTable = document.getElementById('payment-history-table');
        const historyCount = document.getElementById('payment-history-count');
        const toggleDue = document.getElementById('toggle-due-date');
        const dueWrapper = document.getElementById('due-date-wrapper');
        const dueInput = document.getElementById('payment-due-date');
        const dueHidden = document.getElementById('payment-update-due');

        const formatCurrency = (value) => {
            const number = Number(value || 0);
            return `Rp ${number.toLocaleString('id-ID', { maximumFractionDigits: 0 })}`;
        };
        const buildPaymentNumber = () => {
            const now = new Date();
            const pad = (num) => String(num).padStart(2, '0');
            return `PY-${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        };
        const updatePreview = (outstanding) => {
            const paid = parseFloat(amountInput.value || '0');
            const remaining = Math.max(outstanding - paid, 0);
            const change = Math.max(paid - outstanding, 0);
            remainingDisplay.value = formatCurrency(remaining);
            changeDisplay.value = formatCurrency(change);
        };
        const renderHistory = (payments) => {
            if (!historyBody || !historyEmpty || !historyTable || !historyCount) {
                return;
            }
            historyBody.innerHTML = '';
            historyCount.textContent = payments.length;
            if (!payments.length) {
                historyEmpty.hidden = false;
                historyTable.hidden = true;
                return;
            }
            historyEmpty.hidden = true;
            historyTable.hidden = false;
            payments.forEach((payment) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.paid_at || '-'}</td>
                    <td>${payment.method || '-'}</td>
                    <td>${payment.reference || '-'}</td>
                    <td>${payment.note || '-'}</td>
                    <td class="text-right">${formatCurrency(payment.amount || 0)}</td>
                    <td class="text-right">${payment.created_by || '-'}</td>
                `;
                historyBody.appendChild(row);
            });
        };
        const loadHistory = (saleId) => {
            if (!historyBase || !saleId) {
                renderHistory([]);
                return;
            }
            const url = historyBase.replace(/0$/, String(saleId));
            fetch(url, { headers: { Accept: 'application/json' } })
                .then((response) => response.json())
                .then((data) => renderHistory(data.payments || []))
                .catch(() => renderHistory([]));
        };

        document.querySelectorAll('[data-action="open-payment"]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const outstanding = parseFloat(btn.dataset.outstanding || '0');
                const total = parseFloat(btn.dataset.total || '0');
                const paid = parseFloat(btn.dataset.paid || '0');
                const dueDate = btn.dataset.due || '';

                numberEl.textContent = buildPaymentNumber();
                invoiceEl.textContent = btn.dataset.invoice || '-';
                customerEl.textContent = btn.dataset.customer || '-';
                totalDisplay.value = formatCurrency(total);
                paidDisplay.value = formatCurrency(paid);
                outstandingDisplay.textContent = formatCurrency(outstanding);
                saleIdInput.value = btn.dataset.saleId || '';
                amountInput.value = outstanding.toFixed(0);
                dueInput.value = dueDate || '';
                toggleDue.checked = false;
                dueWrapper.style.display = 'none';
                dueHidden.value = '0';
                updatePreview(outstanding);
                loadHistory(btn.dataset.saleId);

                amountInput.oninput = () => updatePreview(outstanding);
            });
        });

        toggleDue.addEventListener('change', (event) => {
            const isChecked = event.target.checked;
            dueWrapper.style.display = isChecked ? '' : 'none';
            dueHidden.value = isChecked ? '1' : '0';
        });
    })();
</script>
{% endblock %}
