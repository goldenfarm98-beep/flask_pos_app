{% extends "base.html" %}

{% block title %}Data Produk{% endblock %}

{% block content %}
{% set produk_stat = stat_cards|first if stat_cards else None %}

<section class="page-hero hero-card hero-gradient text-white mb-4">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="display-5 font-weight-bold mb-3">Kelola katalog produk dengan tampilan modern.</h1>
            <p class="lead mb-4">
                Pastikan setiap item tercatat rapi, lengkap dengan kategori, pemasok, hingga masa kadaluarsa.
                {% if produk_stat %}
                    Saat ini tercatat <strong>{{ '{:,}'.format(produk_stat.value).replace(',', '.') }}</strong> produk aktif di sistem.
                {% endif %}
            </p>
            <div class="d-flex flex-wrap">
                <a href="#produk-form-card" class="btn btn-light btn-lg text-primary font-weight-bold mr-3 mb-2">
                    <i class="fas fa-plus-circle mr-2"></i>Produk Baru
                </a>
                <a href="{{ url_for('main.export_produk') }}" class="btn btn-outline-light btn-lg mr-3 mb-2">
                    <i class="fas fa-file-download mr-2"></i>Export Excel
                </a>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-light btn-lg mb-2">
                    <i class="fas fa-th-large mr-2"></i>Kembali ke Dashboard
                </a>
            </div>
        </div>
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="hero-meta text-lg-right">
                <span class="badge badge-pill badge-light text-uppercase px-3 py-2">Fitur Utama</span>
                <p class="small text-white-75 mt-3 mb-0">Form input berada di sisi kanan layar dan bersifat responsif untuk layar kecil. Gunakan panel wawasan untuk memastikan data selalu lengkap.</p>
            </div>
        </div>
    </div>
</section>

{% if stat_cards %}
<div class="row stat-grid mb-4">
    {% for card in stat_cards %}
        <div class="col-sm-6 col-xl-3 mb-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="stat-icon {{ card.accent }}">
                            <i class="fas {{ card.icon }}"></i>
                        </span>
                        <span class="badge badge-light text-uppercase font-weight-semibold">{{ card.label }}</span>
                    </div>
                    <div class="stat-value mb-1">
                        {{ '{:,}'.format(card.value).replace(',', '.') }}
                    </div>
                    <p class="small text-muted mb-0">{{ card.description }}</p>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="row align-items-start">
    <div class="col-lg-8">
        <div class="card card-panel shadow-sm mb-4">
            <div class="card-header bg-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div>
                    <h2 class="h5 font-weight-bold mb-1">Daftar Produk</h2>
                    <p class="small text-muted mb-0">Menampilkan {{ pagination.total }} produk sesuai filter yang dipilih.</p>
                </div>
                <a href="{{ url_for('main.produk') }}" class="btn btn-sm btn-outline-primary mt-3 mt-md-0">
                    <i class="fas fa-sync-alt mr-1"></i>Reset filter
                </a>
            </div>
            <div class="card-body">
                <form class="filter-form mb-4" method="GET" action="{{ url_for('main.produk') }}">
                    <div class="row align-items-center">
                        <div class="col-12 col-lg-5 mb-3">
                            <label for="filterSearch" class="sr-only">Cari Produk</label>
                            <div class="input-group shadow-sm filter-input">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white border-right-0"><i class="fas fa-search text-muted"></i></span>
                                </div>
                                <input type="text" id="filterSearch" name="search" class="form-control border-left-0" placeholder="Cari nama, kode, atau SKU" value="{{ request.args.get('search', '') }}">
                            </div>
                        </div>
                        <div class="col-6 col-lg-3 mb-3">
                            <label for="filterKategori" class="sr-only">Kategori</label>
                            <div class="input-group shadow-sm filter-input">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white border-right-0"><i class="fas fa-tags text-muted"></i></span>
                                </div>
                                <select id="filterKategori" name="kategori" class="form-control border-left-0">
                                    <option value="">Semua kategori</option>
                                    {% for kategori in kategoris %}
                                        <option value="{{ kategori.id }}" {% if request.args.get('kategori') == kategori.id|string %}selected{% endif %}>{{ kategori.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3 mb-3">
                            <label for="filterSupplier" class="sr-only">Supplier</label>
                            <div class="input-group shadow-sm filter-input">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white border-right-0"><i class="fas fa-truck text-muted"></i></span>
                                </div>
                                <select id="filterSupplier" name="supplier" class="form-control border-left-0">
                                    <option value="">Semua supplier</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}" {% if request.args.get('supplier') == supplier.id|string %}selected{% endif %}>{{ supplier.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-lg-1 mb-3 d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary btn-icon mr-2" data-toggle="tooltip" title="Cari produk">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <a href="{{ url_for('main.produk') }}" class="btn btn-light btn-icon" data-toggle="tooltip" title="Reset filter">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        </div>
                    </div>
                </form>

                <div id="productTableContainer">
                    {% include 'partials/product_table.html' %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h3 class="h6 font-weight-bold mb-3">Kesehatan data produk</h3>
                        {% set badge_map = {'warning': 'badge-warning', 'info': 'badge-info', 'success': 'badge-success', 'secondary': 'badge-secondary'} %}
                        <ul class="list-unstyled mb-0">
                            {% for insight in health_insights %}
                                <li class="mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="font-weight-semibold">{{ insight.title }}</span>
                                        <span class="badge badge-pill {{ badge_map.get(insight.status, 'badge-secondary') }}">
                                            {{ '{:,}'.format(insight.value).replace(',', '.') }}
                                        </span>
                                    </div>
                                    <p class="small text-muted mb-0">{{ insight.description }}</p>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h3 class="h6 font-weight-bold mb-3">Mendekati kadaluarsa</h3>
                        {% if expiring_products %}
                            <ul class="list-group list-group-flush">
                                {% for produk in expiring_products %}
                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="font-weight-semibold">{{ produk.nama_produk }}</div>
                                            <small class="text-muted d-block">
                                                <i class="fas fa-barcode mr-1"></i>{{ produk.kode_produk }}
                                            </small>
                                        </div>
                                        <div class="text-right">
                                            <span class="badge badge-danger mb-1">
                                                {{ produk.tanggal_expired.strftime('%d %b %Y') }}
                                            </span>
                                            <div class="small text-muted">
                                                {{ produk.supplier.name if produk.supplier else 'Supplier tidak ada' }}
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="small text-muted mb-0">Belum ada produk dengan tanggal kedaluwarsa yang tercatat. Tambahkan tanggal pada produk sensitif.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4" id="produk-form-card">
        <div class="sticky-column">
        <div class="card shadow-lg form-card mb-4">
            <div class="card-body">
                <span class="badge badge-pill badge-primary text-uppercase px-3 py-2">
                    {% if edit_produk %}Perbarui Produk{% else %}Produk Baru{% endif %}
                </span>
                <h2 class="h5 font-weight-bold mt-3 mb-2">
                    {% if edit_produk %}
                        Ubah detail <span class="text-primary">{{ edit_produk.nama_produk }}</span>
                    {% else %}
                        Tambah produk ke katalog
                    {% endif %}
                </h2>
                <p class="small text-muted">Lengkapi informasi utama untuk mempercepat proses penjualan dan analitik stok.</p>

                {% if edit_produk %}
                    <div class="alert alert-info small" role="alert">
                        Anda sedang mengedit produk. Simpan perubahan atau <a href="{{ url_for('main.produk') }}" class="alert-link">batalkan untuk kembali menambah produk baru</a>.
                    </div>
                {% endif %}

                <div class="alert alert-light border small d-flex align-items-start" role="alert">
                    <i class="fas fa-layer-group text-primary mr-2 mt-1"></i>
                    <div>
                        Data satuan dan kategori diambil dari master. Kelola pilihan baru melalui halaman
                        <a href="{{ url_for('main.satuan') }}" class="font-weight-semibold">Data Satuan</a>
                        atau
                        <a href="{{ url_for('main.kategori') }}" class="font-weight-semibold">Data Kategori</a>.
                    </div>
                </div>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="produk_id" value="{% if edit_produk %}{{ edit_produk.id }}{% endif %}">

                    <div class="form-group">
                        <label for="kode_produk">Kode Produk</label>
                        <input type="text" class="form-control" id="kode_produk" name="kode_produk" placeholder="Contoh: BRG-001" value="{{ edit_produk.kode_produk if edit_produk else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="sku">SKU</label>
                        <input type="text" class="form-control" id="sku" name="sku" placeholder="Opsional: SKU internal" value="{{ edit_produk.sku if edit_produk else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="barcode">Barcode</label>
                        <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Kode barcode" value="{{ edit_produk.barcode if edit_produk else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="nama_produk">Nama Produk</label>
                        <input type="text" class="form-control" id="nama_produk" name="nama_produk" placeholder="Nama produk" value="{{ edit_produk.nama_produk if edit_produk else '' }}" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-sm-6">
                            <label for="satuan">Satuan</label>
                            <select class="form-control" id="satuan" name="satuan" required>
                                {% if satuans %}
                                    {% for satuan in satuans %}
                                        <option value="{{ satuan.id }}" {% if edit_produk and satuan.id == edit_produk.satuan_id %}selected{% endif %}>{{ satuan.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled selected>Belum ada data satuan</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">Tidak menemukan opsi? Tambahkan di <a href="{{ url_for('main.satuan') }}">Data Satuan</a>.</small>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="kategori">Kategori</label>
                            <select class="form-control" id="kategori" name="kategori" required>
                                {% if kategoris %}
                                    {% for kategori in kategoris %}
                                        <option value="{{ kategori.id }}" {% if edit_produk and kategori.id == edit_produk.kategori_id %}selected{% endif %}>{{ kategori.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled selected>Belum ada data kategori</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">Atur daftar kategori di <a href="{{ url_for('main.kategori') }}">Data Kategori</a>.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="supplier">Supplier</label>
                        <select class="form-control" id="supplier" name="supplier">
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if edit_produk and supplier.id == edit_produk.supplier_id %}selected{% endif %}>{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-sm-6">
                            <label for="berat">Berat (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="berat" name="berat" placeholder="cth. 0.25" value="{{ edit_produk.berat if edit_produk and edit_produk.berat is not none else '' }}">
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="stok_minimal">Stok Minimal</label>
                            <input type="number" class="form-control" id="stok_minimal" name="stok_minimal" placeholder="cth. 10" value="{{ edit_produk.stok_minimal if edit_produk and edit_produk.stok_minimal is not none else '' }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tanggal_expired">Tanggal Kedaluwarsa</label>
                        <input type="date" class="form-control" id="tanggal_expired" name="tanggal_expired" value="{% if edit_produk and edit_produk.tanggal_expired %}{{ edit_produk.tanggal_expired.strftime('%Y-%m-%d') }}{% endif %}">
                        <small class="form-text text-muted">Opsional: penting untuk produk makanan, kosmetik, dan obat.</small>
                    </div>

                    <div class="price-level-manager border rounded-lg p-3 mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h3 class="h6 font-weight-bold mb-1">Level harga produk</h3>
                                <p class="small text-muted mb-0">Atur harga Retail, marketplace, dan kanal lain dengan cepat.</p>
                            </div>
                            <a href="{{ url_for('main.harga_level') }}" class="btn btn-link btn-sm px-0">
                                <i class="fas fa-layer-group mr-1"></i>Kelola level
                            </a>
                        </div>
                        {% if price_levels %}
                            <div class="form-row align-items-end">
                                <div class="form-group col-sm-6 mb-3 mb-sm-0">
                                    <label for="price_level_selector">Pilih level</label>
                                    <select class="form-control" id="price_level_selector">
                                        <option value="">Pilih level</option>
                                        {% for level in price_levels %}
                                            <option value="{{ level.id }}">{{ level.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group col-sm-6">
                                    <label for="price_level_value">Harga (Rp)</label>
                                    <input type="text" class="form-control" id="price_level_value" placeholder="cth. 68.000">
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm btn-block" id="add_price_level_entry">
                                <i class="fas fa-plus-circle mr-1"></i>Tambahkan level harga
                            </button>
                            <div id="price-level-feedback" class="text-danger small mt-2 d-none"></div>
                            <div class="table-responsive mt-3">
                                <table class="table table-sm mb-0" id="price-level-table">
                                    <thead>
                                        <tr>
                                            <th>Level</th>
                                            <th class="text-right">Harga</th>
                                            <th class="text-right">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-warning small mb-0">
                                Belum ada level harga. Buat minimal satu di halaman <a href="{{ url_for('main.harga_level') }}">Level Harga</a> sebelum menyimpan produk.
                            </div>
                        {% endif %}
                        <input type="hidden" name="price_level_payload" id="price_level_payload_input" value="[]">
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        {% if edit_produk %}Simpan Perubahan{% else %}Simpan Produk{% endif %}
                    </button>
                    {% if edit_produk %}
                        <a href="{{ url_for('main.produk') }}" class="btn btn-light btn-block mt-2">Batalkan edit</a>
                    {% else %}
                        <button type="reset" class="btn btn-outline-secondary btn-block mt-2">Reset form</button>
                    {% endif %}

                    <p class="small text-muted text-center mt-3 mb-0">
                        Gunakan kode produk unik untuk memudahkan pelacakan di laporan penjualan.
                    </p>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="h6 font-weight-bold mb-2">Impor dari Excel</h3>
                <p class="small text-muted mb-3">Gunakan file berekstensi .xlsx dengan kolom sesuai template berikut.</p>
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Kolom</th>
                                <th>Wajib</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in product_import_schema %}
                            <tr>
                                <td class="font-weight-semibold">{{ field.column }}</td>
                                <td>
                                    {% if field.required %}
                                        <span class="badge badge-danger">Ya</span>
                                    {% else %}
                                        <span class="badge badge-light text-muted">Opsional</span>
                                    {% endif %}
                                </td>
                                <td class="small text-muted">{{ field.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <form action="{{ url_for('main.import_produk') }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="importFile" name="file" accept=".xls,.xlsx" required>
                        <label class="custom-file-label" for="importFile">Pilih file Excel</label>
                    </div>
                    <small id="import-file-name" class="text-muted d-block mt-2">Belum ada file dipilih.</small>
                    <button type="submit" class="btn btn-outline-primary btn-block mt-3">
                        <i class="fas fa-file-import mr-2"></i>Impor data
                    </button>
                </form>
                <a href="{{ url_for('main.export_produk') }}" class="btn btn-link btn-sm px-0 mt-3">
                    <i class="fas fa-download mr-1"></i>Unduh backup produk terbaru
                </a>
            </div>
        </div>
        </div>
    </div>
</div>

<style>
    .hero-card {
        border-radius: 20px;
        padding: 2.5rem 2rem;
    }
    .hero-card .btn {
        border-radius: 999px;
    }
    .hero-meta .badge {
        letter-spacing: 0.08em;
    }
    .text-white-75 {
        color: rgba(255, 255, 255, 0.75) !important;
    }
    .font-weight-semibold {
        font-weight: 600;
    }
    .stat-card {
        border-radius: 18px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    }
    .stat-card .stat-icon {
        font-size: 1.75rem;
    }
    .stat-card .stat-value {
        font-size: 1.85rem;
        font-weight: 700;
    }
    .card-panel {
        border-radius: 18px;
    }
    .table-modern thead th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        border-bottom: 2px solid rgba(15, 23, 42, 0.08);
        white-space: nowrap;
    }
    .table-modern tbody td {
        vertical-align: middle;
    }
    .table-modern tbody tr:hover {
        background-color: rgba(37, 99, 235, 0.04);
    }
    .empty-icon {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(37, 99, 235, 0.12);
    }
    .form-card {
        border-radius: 20px;
    }
    .sticky-column {
        position: sticky;
        top: 1.25rem;
    }
    .sticky-column .card + .card {
        margin-top: 1.5rem;
    }
    .filter-input .input-group-text {
        padding: 0.55rem 0.75rem;
        border-radius: 12px 0 0 12px;
    }
    .filter-input .form-control {
        padding: 0.55rem 0.75rem;
        border-radius: 0 12px 12px 0;
        font-size: 0.95rem;
    }
    .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        font-size: 1rem;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 24px rgba(15, 23, 42, 0.16);
    }
    .custom-file-label {
        border-radius: 12px;
    }
    .custom-file-input:focus ~ .custom-file-label {
        box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        border-color: rgba(37, 99, 235, 0.4);
    }
    .price-level-manager {
        background: #f8fafc;
        border-radius: 16px;
    }
    .price-level-manager table th,
    .price-level-manager table td {
        vertical-align: middle;
    }
    .price-badge-stack {
        gap: 0.35rem;
    }
    .badge-soft-primary {
        background-color: rgba(37, 99, 235, 0.12);
        color: #1d4ed8;
        font-weight: 600;
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
    }
    @media (max-width: 992px) {
        .sticky-column {
            position: static;
            top: auto;
        }
    }
    @media (max-width: 576px) {
        .hero-card {
            border-radius: 16px;
            padding: 2rem 1.5rem;
        }
        .stat-card .stat-value {
            font-size: 1.6rem;
        }
    }
</style>

<script>
    const PRICE_LEVEL_SEED = {{ edit_price_levels|default([], true)|tojson }};
    const PRICE_LEVEL_OPTIONS = {{ price_levels_context|default([], true)|tojson }};

    (function initPriceLevelManager() {
        const payloadInput = document.getElementById('price_level_payload_input');
        if (!payloadInput) {
            return;
        }

        const tableBody = document.querySelector('#price-level-table tbody');
        const addButton = document.getElementById('add_price_level_entry');
        const levelSelect = document.getElementById('price_level_selector');
        const priceInput = document.getElementById('price_level_value');
        const feedback = document.getElementById('price-level-feedback');

        const normalizeSeed = (seed) =>
            Array.isArray(seed)
                ? seed
                      .map((entry) => ({
                          level_id: Number(entry.level_id),
                          price: Number(entry.price) || 0,
                      }))
                      .filter((entry) => entry.level_id && entry.price >= 0)
                : [];

        if (!tableBody || !addButton || !levelSelect || !priceInput) {
            payloadInput.value = JSON.stringify(normalizeSeed(PRICE_LEVEL_SEED));
            return;
        }

        const currencyFormatter =
            typeof Intl !== 'undefined' && Intl.NumberFormat
                ? new Intl.NumberFormat('id-ID', {
                      style: 'currency',
                      currency: 'IDR',
                      maximumFractionDigits: 0,
                  })
                : null;

        const getLevelName = (levelId) => {
            const found = (PRICE_LEVEL_OPTIONS || []).find(
                (item) => Number(item.id) === Number(levelId)
            );
            return (found && found.name) || 'Level';
        };

        const formatCurrency = (value) => {
            if (currencyFormatter) {
                return currencyFormatter.format(value || 0);
            }
            return 'Rp ' + (value || 0).toFixed(0);
        };

        const parsePriceValue = (value) => {
            if (typeof value !== 'string') {
                return null;
            }
            const cleaned = value
                .replace(/rp/gi, '')
                .replace(/\s+/g, '')
                .replace(/[^0-9,.-]/g, '')
                .replace(/\./g, '')
                .replace(',', '.');
            if (!cleaned) {
                return null;
            }
            const parsed = Number(cleaned);
            return Number.isFinite(parsed) ? parsed : null;
        };

        const setFeedback = (message, tone) => {
            if (!feedback) {
                return;
            }
            if (!message) {
                feedback.textContent = '';
                feedback.classList.add('d-none');
                return;
            }
            feedback.textContent = message;
            feedback.classList.remove('d-none', 'text-danger', 'text-warning');
            feedback.classList.add(tone === 'warning' ? 'text-warning' : 'text-danger');
        };

        let rows = Array.isArray(PRICE_LEVEL_SEED) ? PRICE_LEVEL_SEED.slice() : [];
        rows = rows.map((entry) => ({
            level_id: Number(entry.level_id),
            level_name: entry.level_name || getLevelName(entry.level_id),
            price: Number(entry.price) || 0,
        }));

        const updatePayload = () => {
            payloadInput.value = JSON.stringify(
                rows.map((entry) => ({
                    level_id: entry.level_id,
                    price: entry.price,
                }))
            );
        };

        const renderRows = () => {
            tableBody.innerHTML = '';
            if (!rows.length) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML =
                    '<td colspan="3" class="text-center text-muted small py-3">Belum ada level harga ditambahkan.</td>';
                tableBody.appendChild(emptyRow);
                updatePayload();
                return;
            }
            rows
                .sort((a, b) =>
                    (a.level_name || '').localeCompare(b.level_name || '')
                )
                .forEach((entry) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="badge badge-soft-primary">${entry.level_name}</span></td>
                        <td class="text-right font-weight-semibold">${formatCurrency(entry.price)}</td>
                        <td class="text-right">
                            <button type="button" class="btn btn-link btn-sm p-0 pr-2 price-level-edit text-primary" data-level-id="${entry.level_id}">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button type="button" class="btn btn-link btn-sm p-0 text-danger price-level-remove" data-level-id="${entry.level_id}">
                                <i class="fas fa-trash mr-1"></i>Hapus
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            updatePayload();
        };

        addButton.addEventListener('click', function () {
            setFeedback('');
            const levelId = parseInt(levelSelect.value, 10);
            if (!levelId) {
                setFeedback('Pilih level harga terlebih dahulu.');
                return;
            }
            const priceValue = parsePriceValue(priceInput.value);
            if (priceValue === null || priceValue < 0) {
                setFeedback('Isi harga dengan angka yang valid.');
                return;
            }
            const entry = {
                level_id: levelId,
                level_name: getLevelName(levelId),
                price: priceValue,
            };
            const existingIndex = rows.findIndex(
                (item) => item.level_id === levelId
            );
            if (existingIndex >= 0) {
                rows[existingIndex] = entry;
            } else {
                rows.push(entry);
            }
            levelSelect.value = '';
            priceInput.value = '';
            renderRows();
        });

        tableBody.addEventListener('click', function (event) {
            const control = event.target.closest('button[data-level-id]');
            if (!control) {
                return;
            }
            const levelId = parseInt(control.dataset.levelId, 10);
            if (control.classList.contains('price-level-remove')) {
                rows = rows.filter((entry) => entry.level_id !== levelId);
                renderRows();
                return;
            }
            const entry = rows.find((item) => item.level_id === levelId);
            if (!entry) {
                return;
            }
            levelSelect.value = String(entry.level_id);
            priceInput.value = entry.price.toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2,
            });
            priceInput.focus();
        });

        renderRows();
    })();

    if (window.jQuery && typeof window.jQuery.fn.tooltip === 'function') {
        $('[data-toggle="tooltip"]').tooltip();
    }

    document.addEventListener('change', function (event) {
        if (!event.target.classList.contains('custom-file-input')) {
            return;
        }
        var input = event.target;
        var label = input.nextElementSibling;
        var helper = document.getElementById('import-file-name');
        if (input.files && input.files.length > 0) {
            var fileName = input.files[0].name;
            if (label) {
                label.textContent = fileName;
            }
            if (helper) {
                helper.textContent = fileName;
                helper.classList.remove('text-muted');
                helper.classList.add('text-primary');
            }
        } else {
            if (label) {
                label.textContent = 'Pilih file Excel';
            }
            if (helper) {
                helper.textContent = 'Belum ada file dipilih.';
                helper.classList.add('text-muted');
                helper.classList.remove('text-primary');
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.querySelector('.filter-form');
        const tableContainer = document.getElementById('productTableContainer');
        if (!filterForm || !tableContainer) return;

        const requestUrl = filterForm.getAttribute('action');

        function setLoading(active) {
            tableContainer.classList.toggle('is-loading', active);
        }

        function updateHistory(params) {
            const url = new URL(requestUrl, window.location.origin);
            Object.entries(params).forEach(([key, value]) => {
                if (!value) {
                    url.searchParams.delete(key);
                    return;
                }
                if (key === 'ajax') {
                    return;
                }
                url.searchParams.set(key, value);
            });
            window.history.replaceState({}, '', url);
        }

        function loadTable(params = {}) {
            setLoading(true);
            const payload = new URLSearchParams();
            Object.entries(params).forEach(([key, value]) => {
                if (value !== undefined && value !== null) {
                    payload.set(key, value);
                }
            });
            payload.set('ajax', '1');

            fetch(`${requestUrl}?${payload.toString()}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Gagal memuat data');
                    }
                    return response.text();
                })
                .then((html) => {
                    tableContainer.innerHTML = html;
                    setLoading(false);
                    updateHistory(params);
                })
                .catch(() => {
                    setLoading(false);
                });
        }

        filterForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(filterForm);
            const params = {};
            formData.forEach((value, key) => {
                params[key] = value;
            });
            params.page = 1;
            loadTable(params);
        });

        tableContainer.addEventListener('click', function (event) {
            const link = event.target.closest('.pagination a');
            if (!link) {
                return;
            }
            event.preventDefault();
            const targetUrl = new URL(link.href, window.location.origin);
            const params = {};
            targetUrl.searchParams.forEach((value, key) => {
                params[key] = value;
            });
            loadTable(params);
        });
    });
</script>

<style>
    #productTableContainer {
        position: relative;
    }

    #productTableContainer.is-loading::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(2px);
        z-index: 10;
    }
</style>
{% endblock %}
