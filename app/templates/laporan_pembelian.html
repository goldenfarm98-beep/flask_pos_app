{% extends "base.html" %}

{% block title %}Laporan Pembelian{% endblock %}

{% macro format_currency(value) -%}
    {{ ('Rp {:,.0f}'.format(value or 0)).replace(',', '.') }}
{%- endmacro %}
{% macro format_number(value) -%}
    {{ '{:,}'.format(value or 0).replace(',', '.') }}
{%- endmacro %}

{% block content %}
<section class="purch-report">
    <div class="card shadow-sm border-0 mb-4 report-hero">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center">
            <div class="flex-fill pr-lg-4">
                <p class="eyebrow text-uppercase mb-2">Laporan Pembelian</p>
                <h1 class="display-5 mb-2 text-navy">Kontrol arus barang masuk</h1>
                <p class="mb-0 text-muted">Lihat pengeluaran, performa supplier, dan tren restock untuk menjaga cashflow bisnis.</p>
            </div>
            <div class="report-period text-lg-right mt-4 mt-lg-0">
                <small class="text-uppercase text-muted d-block">Periode aktif</small>
                <div class="h4 font-weight-bold mb-1">{{ range_label }}</div>
                <span class="badge badge-pill badge-soft-info">{{ active_suppliers }} supplier aktif</span>
            </div>
        </div>
        <div class="card-footer bg-transparent">
            <form class="report-filter" method="get">
                <div class="form-row">
                    <div class="form-group col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <label for="start_date" class="text-muted small text-uppercase">Mulai</label>
                        <input type="date" id="start_date" name="start_date" class="form-control form-control-lg" value="{{ filter_values.start_date }}">
                    </div>
                    <div class="form-group col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <label for="end_date" class="text-muted small text-uppercase">Sampai</label>
                        <input type="date" id="end_date" name="end_date" class="form-control form-control-lg" value="{{ filter_values.end_date }}">
                    </div>
                    <div class="form-group col-lg-3 col-md-6">
                        <label for="supplier" class="text-muted small text-uppercase">Supplier</label>
                        <select id="supplier" name="supplier" class="custom-select custom-select-lg">
                            <option value="">Semua supplier</option>
                            {% for supplier in supplier_options %}
                                <option value="{{ supplier.id }}" {% if filter_values.supplier == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-lg-3 col-md-6">
                        <label for="search" class="text-muted small text-uppercase">Cari faktur / supplier</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" id="search" name="search" class="form-control" placeholder="Misal: INV-2025 / Andalan" value="{{ filter_values.search }}">
                        </div>
                    </div>
                </div>
                <div class="form-row justify-content-end mt-3">
                    <div class="col-lg-3 col-md-4 mb-2 mb-md-0">
                        <a class="btn btn-outline-primary btn-lg btn-block" href="{{ url_for('main.laporan_pembelian_print', **request.args) }}" target="_blank" rel="noreferrer">
                            <i class="fas fa-print mr-2"></i>Cetak Laporan
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-4">
                        <button class="btn btn-primary btn-lg btn-block" type="submit">
                            <i class="fas fa-sync mr-2"></i>Perbarui Laporan
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row summary-grid">
        {% for card in summary_cards %}
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="metric-card shadow-sm h-100">
                <div class="metric-icon {{ card.accent }}">
                    <i class="fas {{ card.icon }}"></i>
                </div>
                <div class="metric-body">
                    <small class="text-uppercase text-muted">{{ card.label }}</small>
                    {% if loop.index == 4 %}
                        <div class="metric-value">{{ format_number(card.value) }}</div>
                    {% else %}
                        <div class="metric-value">{{ format_currency(card.value) }}</div>
                    {% endif %}
                    <p class="mb-0 text-muted small">{{ card.subtitle }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <p class="eyebrow text-uppercase mb-1">Detail transaksi</p>
                    <h3 class="h5 mb-0">Daftar faktur pembelian</h3>
                </div>
                <span class="badge badge-pill badge-light">
                    {{ purchase_table|length }} faktur terfilter
                </span>
            </div>
            {% if filter_active %}
                <div class="alert alert-info py-2 px-3 small mb-3">
                    Filter aktif: periode {{ range_label }}
                    {% if filter_values.supplier %}
                        • Supplier tertentu
                    {% endif %}
                    {% if filter_values.search %}
                        • Kata kunci “{{ filter_values.search }}”
                    {% endif %}
                </div>
            {% endif %}
            {% if purchase_table %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle purchase-table mb-0">
                        <thead class="text-muted text-uppercase small">
                            <tr>
                                <th>Faktur</th>
                                <th>Supplier</th>
                                <th>Tanggal</th>
                                <th>Pembayaran</th>
                                <th class="text-center">Item</th>
                                <th class="text-right">Total</th>
                                <th class="text-right">Detail</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for purchase in purchase_table %}
                                <tr>
                                    <td>
                                        <div class="font-weight-semibold text-navy">{{ purchase.no_faktur }}</div>
                                        <small class="text-muted">ID #{{ purchase.id }}</small>
                                    </td>
                                    <td>
                                        <div class="font-weight-semibold">{{ purchase.supplier }}</div>
                                    </td>
                                    <td>{{ purchase.tanggal_label }}</td>
                                    <td><span class="badge badge-soft-info">{{ purchase.payment or 'Tunai' }}</span></td>
                                    <td class="text-center font-weight-semibold">{{ format_number(purchase.units) }}</td>
                                    <td class="text-right font-weight-semibold text-primary">{{ format_currency(purchase.total) }}</td>
                                    <td class="text-right">
                                        <button type="button" class="btn btn-link btn-sm detail-toggle" data-target="purchase-detail-{{ purchase.id }}">
                                            Lihat detail
                                        </button>
                                    </td>
                                </tr>
                                <tr class="purchase-detail-row" id="purchase-detail-{{ purchase.id }}" hidden>
                                    <td colspan="7">
                                        <div class="purchase-detail-card">
                                            <div class="d-flex justify-content-end mb-2 flex-wrap" style="gap: 0.4rem;">
                                                <a href="{{ url_for('main.laporan_pembelian_print_detail', purchase_id=purchase.id) }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noreferrer">
                                                    <i class="fas fa-print mr-1"></i>Cetak transaksi
                                                </a>
                                            </div>
                                            <div class="detail-meta-grid">
                                                <div>
                                                    <small class="label text-uppercase">Faktur</small>
                                                    <div class="value">{{ purchase.no_faktur }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">Supplier</small>
                                                    <div class="value">{{ purchase.supplier }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">Tanggal</small>
                                                    <div class="value">{{ purchase.tanggal_label }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">Pembayaran</small>
                                                    <div class="value">{{ purchase.payment or 'Tunai' }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">Jatuh tempo</small>
                                                    <div class="value">{{ purchase.due_date_label }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">Bank</small>
                                                    <div class="value">{{ purchase.payment_bank }}</div>
                                                </div>
                                                <div>
                                                    <small class="label text-uppercase">No referensi</small>
                                                    <div class="value">{{ purchase.payment_reference }}</div>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-sm mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Produk</th>
                                                            <th>Kode</th>
                                                            <th class="text-center">Qty</th>
                                                            <th class="text-right">Harga beli</th>
                                                            <th class="text-right">Diskon %</th>
                                                            <th class="text-right">Pajak %</th>
                                                            <th class="text-right">Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for item in purchase.line_items %}
                                                            <tr>
                                                                <td>{{ item.name }}</td>
                                                                <td>{{ item.code }}</td>
                                                                <td class="text-center">{{ format_number(item.qty) }}</td>
                                                                <td class="text-right">{{ format_currency(item.unit_price) }}</td>
                                                                <td class="text-right text-muted">{{ item.discount }}</td>
                                                                <td class="text-right text-muted">{{ item.tax }}</td>
                                                                <td class="text-right font-weight-semibold">{{ format_currency(item.line_total) }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-clipboard-list fa-2x mb-3"></i>
                    <p class="mb-0">Tidak ada faktur yang cocok dengan filter saat ini.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="eyebrow text-uppercase mb-1">Tren pengeluaran</p>
                            <h3 class="h5 mb-0">Belanja harian</h3>
                        </div>
                        <span class="badge badge-pill badge-light">{{ daily_points|length }} hari dianalisis</span>
                    </div>
                    <div class="chart-shell">
                        <canvas id="purchaseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="eyebrow text-uppercase mb-1">Ringkasan Bulanan</p>
                            <h3 class="h5 mb-0">Performa restock</h3>
                        </div>
                    </div>
                    {% if monthly_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead class="text-muted text-uppercase small">
                                <tr>
                                    <th>Bulan</th>
                                    <th class="text-right">Pengeluaran</th>
                                    <th class="text-right">Unit masuk</th>
                                    <th class="text-right">Biaya / unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_breakdown %}
                                {% set avg_cost = (row.spent / row.units) if row.units else 0 %}
                                <tr>
                                    <td class="font-weight-semibold">{{ row.label }}</td>
                                    <td class="text-right">{{ format_currency(row.spent) }}</td>
                                    <td class="text-right">{{ format_number(row.units) }}</td>
                                    <td class="text-right text-muted">{{ format_currency(avg_cost) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Belum ada faktur pembelian pada rentang ini.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Insight cepat</p>
                    <h3 class="h5 mb-3">Kesehatan pasokan</h3>
                    <ul class="list-unstyled mb-0 insight-list">
                        {% for insight in insight_cards %}
                        <li class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="font-weight-semibold">{{ insight.title }}</span>
                                    <p class="text-muted small mb-0">{{ insight.description }}</p>
                                </div>
                                <div class="text-right">
                                    {% if insight.type == 'currency' %}
                                        <div class="h5 mb-0">{{ format_currency(insight.value) }}</div>
                                    {% else %}
                                        <div class="h5 mb-0">{{ format_number(insight.value) }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Supplier berkontribusi</p>
                    <h3 class="h5 mb-3">Top Supplier</h3>
                    {% if top_suppliers %}
                    <div class="top-supplier-list">
                        {% for supplier in top_suppliers %}
                        <div class="top-supplier-item">
                            <div>
                                <div class="font-weight-semibold">{{ supplier.name }}</div>
                                <small class="text-muted">{{ format_number(supplier.invoices) }} faktur • {{ format_number(supplier.units) }} unit</small>
                            </div>
                            <div class="text-right">
                                <div class="text-primary font-weight-semibold">{{ format_currency(supplier.spent) }}</div>
                                <small class="text-muted">Total belanja</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Belum ada supplier yang tercatat.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Ringkasan supplier</p>
                    <h3 class="h5 mb-3">Semua supplier terfilter</h3>
                    {% if supplier_breakdown %}
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless mb-0">
                                <thead class="text-muted text-uppercase small">
                                    <tr>
                                        <th>Supplier</th>
                                        <th class="text-right">Faktur</th>
                                        <th class="text-right">Pengeluaran</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for supplier in supplier_breakdown %}
                                        <tr>
                                            <td>{{ supplier.name }}</td>
                                            <td class="text-right">{{ format_number(supplier.invoices) }}</td>
                                            <td class="text-right font-weight-semibold">{{ format_currency(supplier.spent) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Belum ada supplier pada filter saat ini.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Faktur terbesar</p>
                    <div class="largest-card">
                        <div class="value">{{ format_currency(largest_invoice.amount) }}</div>
                        <p class="mb-1 text-muted">{{ largest_invoice.supplier }}</p>
                        <small class="text-muted">{{ largest_invoice.date }}</small>
                        <div class="mt-3 d-flex justify-content-between text-muted small">
                            <span>Avg Faktur</span>
                            <strong>{{ format_currency(average_invoice) }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script type="application/json" id="pembelian-chart-data">{{ daily_points|tojson }}</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const script = document.getElementById('pembelian-chart-data');
        const dataset = script ? JSON.parse(script.textContent || '[]') : [];
        const canvas = document.getElementById('purchaseChart');
        if (canvas && window.Chart && dataset.length) {
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            if (parent) {
                canvas.width = parent.clientWidth || 800;
            }
            canvas.height = 240;
            const labels = dataset.map(item => item.label);
            const spendData = dataset.map(item => item.spent);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Pengeluaran',
                            data: spendData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.15)',
                            borderWidth: 3,
                            tension: 0.35,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: false,
                    responsiveAnimationDuration: 0,
                    transitions: {
                        active: { animation: { duration: 0 } },
                        resize: { animation: { duration: 0 } }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y || 0;
                                    return `Pengeluaran: Rp ${value.toLocaleString('id-ID')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'Rp ' + Number(value).toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }

        const detailToggles = document.querySelectorAll('.detail-toggle');
        const detailRows = document.querySelectorAll('.purchase-detail-row');
        detailToggles.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                const targetRow = document.getElementById(targetId);
                if (!targetRow) {
                    return;
                }
                const shouldOpen = targetRow.hasAttribute('hidden');
                detailRows.forEach(row => row.setAttribute('hidden', ''));
                detailToggles.forEach(btn => btn.classList.remove('text-primary'));
                if (shouldOpen) {
                    targetRow.removeAttribute('hidden');
                    button.classList.add('text-primary');
                }
            });
        });
    });
</script>

<style>
    .purch-report .eyebrow {
        letter-spacing: 0.25em;
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .purch-report .text-navy {
        color: #0f172a;
    }

    .report-hero {
        border-radius: 24px;
    }

    .badge-soft-info {
        background: rgba(14, 165, 233, 0.18);
        color: #0e7490;
        font-weight: 600;
    }

    .summary-grid .metric-card {
        border-radius: 20px;
        padding: 1.25rem;
        background: #fff;
        display: flex;
        align-items: center;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        margin-right: 1rem;
    }

    .metric-body .metric-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0f172a;
    }

    .metric-icon.text-primary {
        background: rgba(37, 99, 235, 0.12);
    }

    .metric-icon.text-success {
        background: rgba(34, 197, 94, 0.15);
    }

    .metric-icon.text-warning {
        background: rgba(245, 158, 11, 0.18);
    }

    .metric-icon.text-info {
        background: rgba(6, 182, 212, 0.18);
    }

    .insight-list li:last-child {
        border-bottom: none !important;
    }

    .top-supplier-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .top-supplier-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .top-supplier-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .chart-shell {
        height: 240px;
    }

    .chart-shell canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    .report-filter label {
        font-size: 0.75rem;
        letter-spacing: 0.04em;
    }

    .purchase-table thead th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-top: none;
        background: #f8fafc;
    }

    .purchase-detail-row td {
        background: #f8fafc;
        border-top: none;
    }

    .purchase-detail-card {
        border: 1px dashed rgba(37, 99, 235, 0.3);
        border-radius: 16px;
        padding: 1.5rem;
        background: #fff;
    }

    .detail-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-meta-grid .label {
        font-size: 0.7rem;
        color: #94a3b8;
        letter-spacing: 0.06em;
    }

    .detail-meta-grid .value {
        font-weight: 600;
        color: #0f172a;
    }

    .largest-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #0f172a;
    }

    @media (max-width: 767px) {
        .summary-grid .metric-card {
            flex-direction: column;
            text-align: center;
        }

        .metric-icon {
            margin-bottom: 0.75rem;
        }
    }
</style>
{% endblock %}
