{% extends "base.html" %}
{% block title %}Penjualan{% endblock %}
{% block content %}
<div class="container">
    <h1>Penjualan</h1>
    <form method="POST">
        {{ form.csrf_token }}
        <div class="form-group">
            <label for="pelanggan">Pelanggan</label>
            {{ form.pelanggan_id(class="form-control") }}
        </div>

        <h3>Detail Penjualan</h3>
        <div id="items-container">
            <!-- Barang akan ditambahkan di sini -->
        </div>
        <button type="button" id="add-item" class="btn btn-primary mb-3">Tambah Barang</button>
        <button type="submit" class="btn btn-success">Simpan</button>
    </form>
</div>

<script>
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const item = `
    <div class="form-group row">
        <div class="col-md-5">
            <label for="nama_barang">Nama Barang</label>
            <select name="produk_id[]" class="form-control product-select">
                <option value="" disabled selected>Pilih Produk</option>
                {% for produk in produk_list %}
                <option value="{{ produk.id }}">{{ produk.nama_produk }} ({{ produk.kode_produk }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label>Jumlah</label>
            <input type="number" name="jumlah[]" class="form-control" placeholder="Qty">
        </div>
        <div class="col-md-3">
            <label>Harga</label>
            <input type="number" name="harga[]" class="form-control" placeholder="Harga" readonly>
        </div>
        <div class="col-md-2">
            <label>Aksi</label>
            <button type="button" class="btn btn-danger remove-item">Hapus</button>
        </div>
    </div>`;
    container.insertAdjacentHTML('beforeend', item);

    // Tambahkan event listener untuk tombol "Hapus"
    addRemoveListeners();
});

// Fungsi untuk menghapus barang
function addRemoveListeners() {
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.form-group').remove();
        });
    });
}

addRemoveListeners(); // Tambahkan listener awal
</script>
<script>
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select')) {
            const produkId = e.target.value;
            const hargaInput = e.target.closest('.form-group').querySelector('input[name="harga[]"]');
    
            // Fetch data produk berdasarkan ID
            fetch(`/api/get_product1?product_id=${produkId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hargaInput.value = data.harga; // Isi harga otomatis
                    } else {
                        alert(data.message || 'Produk tidak ditemukan.');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Gagal mengambil data produk.');
                });
        }
    });
    </script>
    
{% endblock %}
