<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembelian</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: auto;
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            text-align: center;
            vertical-align: middle;
        }

        .btn-add {
            background-color: #28a745;
            color: white;
        }

        .btn-add:hover {
            background-color: #218838;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-primary {
            margin-bottom: 5px;
        }

        .btn-secondary {
            margin-top: 5px;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="text-center">Pembelian Barang</h2>
        <form id="purchaseForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="invoiceDate" class="form-label">Tanggal Faktur</label>
                <input type="date" id="invoiceDate" name="tanggal_faktur" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="invoiceNumber" class="form-label">Nomor Faktur</label>
                <input type="text" id="invoiceNumber" name="no_faktur" class="form-control"
                    placeholder="Masukkan nomor faktur" required>
                <small id="fakturMessage" class="form-text"></small>
            </div>

            <div class="mb-3">
                <label for="supplierId" class="form-label">Supplier</label>
                <select id="supplierId" name="supplier" class="form-control" required>
                    <option value="">Pilih Supplier</option>
                </select>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Kode Barang</th>
                        <th>Nama Barang</th>
                        <th>Kategori</th>
                        <th>Jumlah</th>
                        <th>Harga Beli</th>
                        <th>Diskon (%)</th>
                        <th>Pajak (%)</th>
                        <th>HPP</th>
                        <th>Harga Jual</th>
                        <th>Exp Date</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="itemsTable">
                </tbody>
            </table>
            <button type="button" class="btn btn-add btn-sm" onclick="addRow()">
                <i class="fas fa-plus"></i> Tambah Barang
            </button>
            <div class="text-end mt-4">
                <h5>Total Keseluruhan: <span id="grandTotal">0</span></h5>
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100 mb-2">Simpan Pembelian</button>
        </form>
        <div class="text-center mt-2">
            <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
    </div>


    <!-- Modal Cari Barang -->
    <div class="modal fade" id="searchProductModal" tabindex="-1" aria-labelledby="searchProductLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchProductLabel">Cari Barang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="searchProductInput" class="form-control"
                        placeholder="Masukkan kode atau nama barang" onkeyup="searchProduct()">
                    <table class="table mt-3">
                        <thead>
                            <tr>
                                <th>Kode Barang</th>
                                <th>Nama Barang</th>
                                <th>Kategori</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="productSearchResults"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rowCount = 0;

        document.getElementById('purchaseForm').addEventListener('submit', async function (e) {
            e.preventDefault(); // Mencegah reload halaman

            // Validasi kolom kode barang, nama barang, dan kategori
            let valid = true;
            document.querySelectorAll("#itemsTable tr").forEach(row => {
                const kodeBarang = row.querySelector("input[name='kodeBarang[]']").value.trim();
                const namaBarang = row.querySelector("input[name='namaBarang[]']").value.trim();
                const kategori = row.querySelector("input[name='kategori[]']").value.trim();

                if (!kodeBarang || !namaBarang || !kategori) {
                    alert("Kode Barang, Nama Barang, dan Kategori tidak boleh kosong!");
                    valid = false;
                }
            });

            if (!valid) return; // Jika ada kolom kosong, hentikan proses

            // Ambil data dari tabel barang
            const items = [];
            document.querySelectorAll("#itemsTable tr").forEach(row => {
                items.push({
                    kode_barang: row.querySelector("input[name='kodeBarang[]']").value,
                    nama_barang: row.querySelector("input[name='namaBarang[]']").value,
                    kategori: row.querySelector("input[name='kategori[]']").value,
                    jumlah: parseFloat(row.querySelector("input[name='jumlah[]']").value) || 0,
                    harga_beli: parseFloat(row.querySelector("input[name='hargaBeli[]']").value) || 0,
                    diskon: parseFloat(row.querySelector("input[name='diskon[]']").value) || 0,
                    pajak: parseFloat(row.querySelector("input[name='pajak[]']").value) || 0,
                    harga_jual: parseFloat(row.querySelector("input[name='hargaJual[]']").value) || 0,
                    exp_date: row.querySelector("input[name='expDate[]']").value,
                });
            });

            if (items.length === 0) {
                alert("Tambahkan setidaknya 1 barang sebelum menyimpan.");
                return;
            }

            const data = {
                tanggal_faktur: document.getElementById('invoiceDate').value,
                no_faktur: document.getElementById('invoiceNumber').value,
                supplier: document.getElementById('supplierId').value,
                items: items,
            };

            if (!data.tanggal_faktur || !data.no_faktur || !data.supplier) {
                alert("Lengkapi semua data utama sebelum menyimpan.");
                return;
            }

            const csrfToken = document.querySelector('input[name="csrf_token"]').value;

            try {
                const response = await fetch('/pembelian', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('input[name="csrf_token"]').value,
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert("Gagal menyimpan data: " + result.message);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Terjadi kesalahan. Silakan coba lagi.");
            }
        });

        async function loadSuppliers() {
            try {
                const response = await fetch('/api/suppliers');
                if (!response.ok) {
                    throw new Error('Gagal mengambil data supplier.');
                }
                const suppliers = await response.json();
                const supplierSelect = document.getElementById('supplierId');

                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    supplierSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        loadSuppliers();

        function addRow() {
            rowCount++;
            const table = document.getElementById('itemsTable');
            const row = document.createElement('tr');
            row.setAttribute('id', `row${rowCount}`);
            row.innerHTML = `
                <td>${rowCount}</td>
                <td>
                    <div class="d-flex">
                        <input type="text" class="form-control" name="kodeBarang[]" placeholder="Kode barang" readonly required>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openProductSearch(${rowCount})"><i class="fas fa-search"></i></button>
                    </div>
                </td>
                <td><input type="text" class="form-control" name="namaBarang[]" placeholder="Nama barang" readonly required></td>
                <td><input type="text" class="form-control" name="kategori[]" placeholder="Kategori" readonly required></td>
                <td><input type="number" class="form-control" name="jumlah[]" placeholder="Jumlah" min="1" required onchange="updateRow(${rowCount})"></td>
                <td><input type="number" class="form-control" name="hargaBeli[]" placeholder="Harga beli" min="0" required onchange="updateRow(${rowCount})"></td>
                <td><input type="number" class="form-control" name="diskon[]" placeholder="Diskon" min="0" max="100" onchange="updateRow(${rowCount})"></td>
                <td><input type="number" class="form-control" name="pajak[]" placeholder="Pajak" min="0" max="100" onchange="updateRow(${rowCount})"></td>
                <td><input type="text" class="form-control" name="hpp[]" placeholder="HPP" readonly></td>
                <td><input type="number" class="form-control" name="hargaJual[]" placeholder="Harga jual" min="0" required></td>
                <td><input type="date" class="form-control" name="expDate[]" required></td>
                <td><button type="button" class="btn btn-delete btn-sm" onclick="deleteRow(${rowCount})"><i class="fas fa-trash"></i></button></td>
            `;
            table.appendChild(row);
        }

        function updateRow(rowId) {
            const row = document.getElementById(`row${rowId}`);
            const jumlah = parseFloat(row.querySelector("input[name='jumlah[]']").value) || 0;
            const hargaBeli = parseFloat(row.querySelector("input[name='hargaBeli[]']").value) || 0;
            const diskon = parseFloat(row.querySelector("input[name='diskon[]']").value) || 0;
            const pajak = parseFloat(row.querySelector("input[name='pajak[]']").value) || 0;

            const diskonAmount = (diskon / 100) * hargaBeli;
            const pajakAmount = (pajak / 100) * (hargaBeli - diskonAmount);
            const hpp = jumlah > 0 ? (hargaBeli - diskonAmount + pajakAmount) : 0;

            row.querySelector("input[name='hpp[]']").value = (hpp * jumlah).toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            const rows = document.querySelectorAll("#itemsTable tr");
            rows.forEach(row => {
                const hpp = parseFloat(row.querySelector("input[name='hpp[]']").value) || 0;
                grandTotal += hpp;
            });
            document.getElementById('grandTotal').innerText = grandTotal.toLocaleString('id-ID');
        }

        function openProductSearch(rowId) {
            document.getElementById('searchProductModal').setAttribute('data-row-id', rowId);
            const modal = new bootstrap.Modal(document.getElementById('searchProductModal'));
            modal.show();
        }

        async function searchProduct() {
            const query = document.getElementById('searchProductInput').value;
            const response = await fetch(`/api/products?q=${query}`);
            const data = await response.json();

            const results = document.getElementById('productSearchResults');
            results.innerHTML = '';
            data.products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.kode_produk}</td>
                    <td>${product.nama_produk}</td>
                    <td>${product.kategori}</td>
                    <td><button type="button" class="btn btn-primary btn-sm" onclick="selectProduct('${product.kode_produk}', '${product.nama_produk}', '${product.kategori}')">Pilih</button></td>
                `;
                results.appendChild(row);
            });
        }

        function selectProduct(kode, nama, kategori) {
            const rowId = document.getElementById('searchProductModal').getAttribute('data-row-id');
            const row = document.getElementById(`row${rowId}`);

            row.querySelector("input[name='kodeBarang[]']").value = kode;
            row.querySelector("input[name='namaBarang[]']").value = nama;
            row.querySelector("input[name='kategori[]']").value = kategori;

            const modal = bootstrap.Modal.getInstance(document.getElementById('searchProductModal'));
            modal.hide();
        }

        function deleteRow(rowId) {
            document.getElementById(`row${rowId}`).remove();
            updateGrandTotal();
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</body>

</html>