from logging.config import fileConfig
from alembic import context
from sqlalchemy import create_engine, pool
import os

# ── Alembic config & logging ────────────────────────────────────────────────
config = context.config
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ── Ambil DB URL dengan prioritas: ENV → Flask current_app → error ─────────
db_url = os.getenv("SQLALCHEMY_DATABASE_URI") or os.getenv("DATABASE_URL")
if not db_url:
    try:
        from flask import current_app
        db_url = current_app.config.get("SQLALCHEMY_DATABASE_URI")
    except Exception:
        db_url = None

if not db_url:
    raise RuntimeError(
        "DATABASE_URL / SQLALCHEMY_DATABASE_URI tidak ter-set. "
        "Set dulu di environment atau .env."
    )

# ── Dapatkan metadata untuk autogenerate (fallback kalau context Flask belum ada)
target_metadata = None
try:
    from flask import current_app
    target_metadata = current_app.extensions["migrate"].db.metadata
except Exception:
    try:
        # Import app factory & db agar bisa autogenerate tanpa current_app dari CLI
        from app import create_app
        from app import db as _db
        app = create_app()
        app.app_context().push()
        target_metadata = _db.metadata
    except Exception:
        target_metadata = None  # masih bisa jalan untuk upgrade/current

# ── Mode offline (tanpa koneksi) ────────────────────────────────────────────
def run_migrations_offline() -> None:
    context.configure(
        url=db_url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        compare_type=True,
    )
    with context.begin_transaction():
        context.run_migrations()

# ── Mode online (pakai koneksi langsung) ────────────────────────────────────
def run_migrations_online() -> None:
    connectable = create_engine(db_url, poolclass=pool.NullPool)
    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True,
        )
        with context.begin_transaction():
            context.run_migrations()

# ── Jalankan sesuai mode ────────────────────────────────────────────────────
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

