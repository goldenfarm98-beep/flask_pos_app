{% extends "base.html" %}

{% block title %}Laporan Laba Rugi{% endblock %}

{% block content %}
{% macro format_currency(value) -%}
    {{ ('Rp {:,.0f}'.format(value or 0)).replace(',', '.') }}
{%- endmacro %}
{% macro format_number(value) -%}
    {{ '{:,}'.format(value or 0).replace(',', '.') }}
{%- endmacro %}

<section class="pnl-report">
    <div class="card shadow-sm border-0 mb-4 report-hero">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center">
            <div class="flex-fill pr-lg-4">
                <p class="eyebrow text-uppercase mb-2">Laporan Laba Rugi</p>
                <h1 class="display-5 mb-2 text-navy">Insight profit realtime</h1>
                <p class="mb-0 text-muted">Pantau kesehatan bisnis dengan memonitor penjualan, HPP, laba kotor, dan laba bersih dalam satu tampilan modern.</p>
            </div>
            <div class="report-period text-lg-right mt-4 mt-lg-0">
                <small class="text-uppercase text-muted">Periode aktif</small>
                <div class="h4 font-weight-bold mb-1">{{ range_label }}</div>
                <span class="badge badge-pill badge-soft-success">Margin kotor {{ '%.1f'|format(gross_margin_percent) }}% â€¢ bersih {{ '%.1f'|format(net_margin_percent) }}%</span>
            </div>
        </div>
        <div class="card-footer bg-transparent">
            <form class="form-row align-items-end" method="get">
                <div class="form-group col-md-4 mb-0">
                    <label for="start_date" class="text-muted small text-uppercase">Mulai</label>
                    <input type="date" id="start_date" name="start_date" class="form-control form-control-lg" value="{{ filter_values.start_date }}">
                </div>
                <div class="form-group col-md-4 mb-0">
                    <label for="end_date" class="text-muted small text-uppercase">Sampai</label>
                    <input type="date" id="end_date" name="end_date" class="form-control form-control-lg" value="{{ filter_values.end_date }}">
                </div>
                <div class="form-group col-md-4 mb-0">
                    <button class="btn btn-primary btn-lg btn-block" type="submit">
                        <i class="fas fa-sync-alt mr-2"></i>Perbarui Laporan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row summary-grid">
        {% for card in summary_cards %}
        <div class="col-md-6 col-xl-3 mb-4">
            <div class="metric-card shadow-sm h-100">
                <div class="metric-icon {{ card.accent }}">
                    <i class="fas {{ card.icon }}"></i>
                </div>
                <div class="metric-body">
                    <small class="text-uppercase text-muted">{{ card.label }}</small>
                    <div class="metric-value">{{ format_currency(card.value) }}</div>
                    <p class="mb-0 text-muted small">{{ card.subtitle }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="eyebrow text-uppercase mb-1">Tren harian</p>
                            <h3 class="h5 mb-0">Penjualan kotor vs Laba Kotor</h3>
                        </div>
                        <span class="badge badge-pill badge-light">{{ daily_points|length }} hari dianalisis</span>
                    </div>
                    <div class="chart-shell">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="eyebrow text-uppercase mb-1">Ringkasan Bulanan</p>
                            <h3 class="h5 mb-0">Performa periodik</h3>
                        </div>
                    </div>
                    {% if monthly_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead class="text-muted text-uppercase small">
                                <tr>
                                    <th>Bulan</th>
                                    <th class="text-right">Penjualan kotor</th>
                                    <th class="text-right">Laba kotor</th>
                                    <th class="text-right">Margin kotor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_breakdown %}
                                <tr>
                                    <td class="font-weight-semibold">{{ row.label }}</td>
                                    <td class="text-right">{{ format_currency(row.revenue) }}</td>
                                    <td class="text-right text-success">{{ format_currency(row.gross) }}</td>
                                    <td class="text-right text-muted">
                                        {% set margin = (row.gross / row.revenue * 100) if row.revenue else 0 %}
                                        {{ '%.1f'|format(margin) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Belum ada data penjualan pada periode ini.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Kesehatan Bisnis</p>
                    <h3 class="h5 mb-3">Metrik kunci</h3>
                    <ul class="list-unstyled mb-0 insight-list">
                        {% for insight in insight_cards %}
                        <li class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="font-weight-semibold">{{ insight.title }}</span>
                                    <p class="text-muted small mb-0">{{ insight.description }}</p>
                                </div>
                                <div class="text-right">
                                    {% if insight.type == 'currency' %}
                                        <div class="h5 mb-0">{{ format_currency(insight.value) }}</div>
                                    {% else %}
                                        <div class="h5 mb-0">{{ format_number(insight.value) }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Produk paling menguntungkan</p>
                    <h3 class="h5 mb-3">Top 5 Gross Profit</h3>
                    {% if top_products %}
                    <div class="top-product-list">
                        {% for product in top_products %}
                        <div class="top-product-item">
                            <div>
                                <div class="font-weight-semibold">{{ product.name }}</div>
                                <small class="text-muted">Terjual {{ format_number(product.units) }} unit</small>
                            </div>
                            <div class="text-right">
                                <div class="text-success font-weight-semibold">{{ format_currency(product.gross) }}</div>
                                <small class="text-muted">{{ format_currency(product.revenue) }} revenue</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Belum ada data produk dalam rentang ini.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <p class="eyebrow text-uppercase mb-2">Rangkuman cepat</p>
                    <div class="quick-summary">
                        <div>
                            <span class="label">Tax collected</span>
                            <div class="value text-info">{{ format_currency(totals.tax) }}</div>
                        </div>
                        <div>
                            <span class="label">Diskon</span>
                            <div class="value text-warning">{{ format_currency(totals.discount) }}</div>
                        </div>
                        <div>
                            <span class="label">Margin kotor</span>
                            <div class="value">{{ '%.1f'|format(gross_margin_percent) }}%</div>
                        </div>
                        <div>
                            <span class="label">Margin bersih</span>
                            <div class="value">{{ '%.1f'|format(net_margin_percent) }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script type="application/json" id="laba-rugi-data">{{ daily_points|tojson }}</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const datasetScript = document.getElementById('laba-rugi-data');
        const dataset = datasetScript ? JSON.parse(datasetScript.textContent || '[]') : [];
        const canvas = document.getElementById('profitChart');
        if (!canvas || !window.Chart || !dataset.length) {
            return;
        }
        const parent = canvas.parentElement;
        if (parent) {
            canvas.width = parent.clientWidth || 800;
        }
        canvas.height = 260;
        const labels = dataset.map(item => item.label);
        const revenueData = dataset.map(item => item.revenue);
        const grossData = dataset.map(item => item.gross);
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Penjualan kotor',
                        data: revenueData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.35,
                        borderWidth: 3,
                        fill: true,
                    },
                    {
                        label: 'Laba Kotor',
                        data: grossData,
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(34, 197, 94, 0.15)',
                        tension: 0.35,
                        borderDash: [6, 4],
                        borderWidth: 3,
                        fill: false,
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                responsiveAnimationDuration: 0,
                transitions: {
                    active: {
                        animation: {
                            duration: 0
                        }
                    },
                    resize: {
                        animation: {
                            duration: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        align: 'end',
                        labels: {
                            boxWidth: 12,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed.y || 0;
                                return `${context.dataset.label}: Rp ${value.toLocaleString('id-ID')}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return 'Rp ' + Number(value).toLocaleString('id-ID');
                            }
                        }
                    }
                }
            }
        });
    });
</script>

<style>
    .pnl-report .eyebrow {
        letter-spacing: 0.25em;
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .pnl-report .text-navy {
        color: #0f172a;
    }

    .report-hero {
        border-radius: 24px;
    }

    .chart-shell {
        height: 260px;
    }

    .chart-shell canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    .badge-soft-success {
        background: rgba(34, 197, 94, 0.2);
        color: #15803d;
        font-weight: 600;
    }

    .summary-grid .metric-card {
        border-radius: 20px;
        padding: 1.25rem;
        background: #fff;
        display: flex;
        align-items: center;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        margin-right: 1rem;
    }

    .metric-body .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0f172a;
    }

    .metric-icon.text-primary {
        background: rgba(37, 99, 235, 0.12);
    }

    .metric-icon.text-secondary {
        background: rgba(15, 23, 42, 0.08);
    }

    .metric-icon.text-success {
        background: rgba(34, 197, 94, 0.15);
    }

    .metric-icon.text-info {
        background: rgba(6, 182, 212, 0.15);
    }

    .insight-list li:last-child {
        border-bottom: none !important;
    }

    .top-product-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .top-product-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .top-product-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .quick-summary {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
    }

    .quick-summary .label {
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        color: #94a3b8;
    }

    .quick-summary .value {
        font-size: 1.1rem;
        font-weight: 600;
    }

    @media (max-width: 767px) {
        .summary-grid .metric-card {
            flex-direction: column;
            text-align: center;
        }

        .metric-icon {
            margin-bottom: 0.75rem;
        }
    }
</style>
{% endblock %}
